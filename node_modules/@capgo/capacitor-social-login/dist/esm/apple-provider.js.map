{"version":3,"file":"apple-provider.js","sourceRoot":"","sources":["../../src/apple-provider.ts"],"names":[],"mappings":"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","sourcesContent":["import { BaseSocialLogin } from './base';\nimport type { AppleProviderOptions, AppleProviderResponse, AuthorizationCode, LoginResult } from './definitions';\n\ndeclare const AppleID: any;\n\nexport class AppleSocialLogin extends BaseSocialLogin {\n  private clientId: string | null = null;\n  private redirectUrl: string | null = null;\n  private scriptLoaded = false;\n  private scriptUrl = 'https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js';\n  private useProperTokenExchange = false;\n\n  async initialize(\n    clientId: string | null,\n    redirectUrl: string | null | undefined,\n    useProperTokenExchange = false,\n  ): Promise<void> {\n    this.clientId = clientId;\n    this.redirectUrl = redirectUrl || null;\n    this.useProperTokenExchange = useProperTokenExchange;\n\n    if (clientId) {\n      await this.loadAppleScript();\n    }\n  }\n\n  async login(options: AppleProviderOptions): Promise<LoginResult> {\n    if (!this.clientId) {\n      throw new Error('Apple Client ID not set. Call initialize() first.');\n    }\n\n    if (!this.scriptLoaded) {\n      throw new Error('Apple Sign-In script not loaded.');\n    }\n\n    return new Promise((resolve, reject) => {\n      AppleID.auth.init({\n        clientId: this.clientId ?? '',\n        scope: options.scopes?.join(' ') || 'name email',\n        redirectURI: this.redirectUrl || window.location.href,\n        state: options.state,\n        nonce: options.nonce,\n        usePopup: true,\n      });\n\n      AppleID.auth\n        .signIn()\n        .then((res: any) => {\n          let accessToken: { token: string } | null = null;\n\n          if (this.useProperTokenExchange) {\n            // When using proper token exchange, the authorization code should be exchanged\n            // for a proper access token on the backend. For now, we set accessToken to null\n            // and provide the authorization code in a separate field for backend processing.\n            accessToken = null;\n          } else {\n            // Legacy behavior: use authorization code as access token for backward compatibility\n            accessToken = {\n              token: res.authorization.code || '',\n            };\n          }\n\n          const result: AppleProviderResponse = {\n            profile: {\n              user: res.user || '',\n              email: res.user?.email || null,\n              givenName: res.user?.name?.firstName || null,\n              familyName: res.user?.name?.lastName || null,\n            },\n            accessToken: accessToken,\n            idToken: res.authorization.id_token || null,\n            // Add authorization code for proper token exchange when flag is enabled\n            ...(this.useProperTokenExchange && { authorizationCode: res.authorization.code }),\n          };\n          resolve({ provider: 'apple', result });\n        })\n        .catch((error: any) => {\n          reject(error);\n        });\n    });\n  }\n\n  async logout(): Promise<void> {\n    // Apple doesn't provide a logout method for web\n    console.log('Apple logout: Session should be managed on the client side');\n  }\n\n  async isLoggedIn(): Promise<{ isLoggedIn: boolean }> {\n    // Apple doesn't provide a method to check login status on web\n    console.log('Apple login status should be managed on the client side');\n    return { isLoggedIn: false };\n  }\n\n  async getAuthorizationCode(): Promise<AuthorizationCode> {\n    // Apple authorization code should be obtained during login\n    console.log('Apple authorization code should be stored during login');\n    throw new Error('Apple authorization code not available');\n  }\n\n  async refresh(): Promise<void> {\n    // Apple doesn't provide a refresh method for web\n    console.log('Apple refresh not available on web');\n  }\n\n  private async loadAppleScript(): Promise<void> {\n    if (this.scriptLoaded) return;\n\n    return this.loadScript(this.scriptUrl).then(() => {\n      this.scriptLoaded = true;\n    });\n  }\n}\n"]}