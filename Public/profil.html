<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="app.profile_title">Moj Profil - Gourmet & Experience</title>

  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.11.5/i18next.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-http-backend/2.5.2/i18nextHttpBackend.min.js"></script>
  <script src="capacitor.js"></script> 

<style>
    /* SPECIFIƒåEN CSS ZA PROFIL */
    .profil-sekcija {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ===== GLAVA IN SKRIVANJE ELEMENTOV ===== */
    .logotip {
        display: none !important; 
    }
    .jezik-ovoj {
        display: none !important; 
    }
    
    /* SKRIVANJE ELEMENTOV */
    .skrij-formular {
        display: none;
    }
    /* Modal za oceno na zaƒçetku ni viden */
    .skrij-modal { 
        display: none !important; 
    }

    /* üö® KLJUƒåNI STIL ZA CAPACITOR BARCODESCANNER üö® */
    .barcode-scanner-active {
        display: none; 
    }


    /* ===== STIIL ZA GUMBE, VKLJUƒåNO S PRILAGODITVIJO ===== */
    
    .gumb-prijava, 
    .gumb-profil, 
    .gumb-odjava, 
    .kartica-podatkov button,
    .modal-vsebina button[type="submit"],
    #qr-scan-button { 
      display: inline-flex;
      align-items: center;
      gap: 5px; 
      padding: 8px 15px; 
      border-radius: 20px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      white-space: nowrap;
      font-size: 14px;
      cursor: pointer; 
      margin-top: 15px; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    /* Primarni stil za gumbe */
    .gumb-prijava,
    .gumb-profil,
    .kartica-podatkov button:not(.gumb-odjava):not(.gumb-preklici):not(.status-potrjeno),
    .modal-vsebina button[type="submit"] {
      background-color: #575757;
      color: white;
      border: 1px solid #575757;
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    /* üöÄ STIL: QR GUMB */
    #qr-scan-button {
      background: none; 
      color: #333; 
      border: none; 
      font-size: 16px;
      padding: 10px 0; 
      border-radius: 0;
      margin-top: 0; 
      cursor: pointer;
      font-weight: normal; 
      gap: 0; 
      display: flex; /* Dodano za poravnavo ikone in besedila v vrsti */
      align-items: center; /* Poravnaj navpiƒçno */
      width: 100%; /* Da zavzame celotno ≈°irino, kar omogoƒça prelamljanje */
    }
    
    /* ================================================================= */
/* NOVO: Ovalni ovoj za celoten blok QR skenerja */
/* ================================================================= */

.qr-scan-ovoj {
    /* Odstranimo stari stil, ki je bil samo ƒçrta */
    /* padding: 15px 0; */
    /* margin-bottom: 15px; */
    /* border-bottom: 1px solid #eee; */
    
    /* üü¢ NOVI OVALNI OVOJ (KARTICA) üü¢ */
    background-color: white; /* Bela notranjost */
    border-radius: 12px; /* Zaobljeni robovi */
    padding: 15px; /* Notranji rob znotraj ovoja */
    margin: 15px; /* Zunanji rob, da se kartica loƒçi od okolice */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Senƒçenje, da izgleda kot kartica */
    
    /* Prepriƒçajte se, da je ta element display:block ali display:flex */
    display: block; 
}


/* ================================================================= */
/* OBSTOJEƒåI STILI ZA NOTRANJO VSEBINO (QR gumb) */
/* ================================================================= */

#qr-scan-button {
    display: flex; /* Kljuƒçno za poravnavo ikone in besedila */
    align-items: center; /* Vertikalna poravnava */
    width: 100%; /* Da zasede celoten prostor znotraj ovoja */
}

/* Ovoj za ikono fotoaparata (Krog - OSTANE ENAK) */
#qr-scan-button .icon-ovoj {
    width: 45px;
    height: 45px;
    background-color: #00979C; 
    border-radius: 50%; 
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    margin-right: 15px; 
    flex-shrink: 0; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
}

/* Besedilo zraven ikone (OSTANE ENAK) */
#qr-scan-button .text-ovoj {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    line-height: 1.2; 
    flex-grow: 1; 
}

/* Poudarjeno glavno besedilo (OSTANE ENAK) */
#qr-scan-button .main-text {
    font-weight: bold;
    color: #333; 
    font-size: 16px;
    margin-bottom: 2px;
    white-space: normal;
}

/* Sekundarno, manj poudarjeno besedilo (OSTANE ENAK) */
#qr-scan-button .sub-text {
    font-weight: normal; 
    color: #333; 
    font-size: 13px;
    opacity: 0.85; 
    white-space: normal;
}


    .gumb-prijava:hover, 
    .gumb-profil:hover,
    .kartica-podatkov button:not(.gumb-odjava):not(.gumb-preklici):not(.status-potrjeno):hover,
    .modal-vsebina button[type="submit"]:hover {
      background-color: #787878;
      border-color: #787878;
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    /* Sekundarni/Outline gumb */
    .gumb-odjava {
      background-color: transparent; 
      color: #3e3e3e; 
      border: 1px solid #3e3e3e;
      margin-left: 10px; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    .gumb-odjava:hover {
      background-color: #d3d3d3; 
      color: #424242;
      border-color: #424242;
    }

    /* Gumb za Preklic (Nevarnost) */
    .gumb-preklici {
      background-color: #e74c3c; 
      color: white;
      font-size: 14px;
      border: 1px solid #e74c3c;
      padding: 8px 15px; 
      border-radius: 20px;
      margin-left: 10px; 
      margin-top: 0; 
      align-self: flex-start; 
      cursor: pointer; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    .gumb-preklici:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }
    
    /* üöÄ NOVO: Stil za Potrjeno stanje (Zelena) */
    .status-potrjeno {
        color: white;
        background-color: #28a745; 
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        flex-shrink: 0;
        text-align: center;
        border: 1px solid #28a745;
        height: 35px; 
        display: flex;
        align-items: center;
        justify-content: center;
    }


    /* OVOJ ZA PROFIL */
    .profil-ovoj {
        display: flex; 
        align-items: center;
        gap: 10px; 
    }

    /* GUMB NAZAJ */
    .gumb-nazaj {
      text-decoration: none;
      color: white;
      background-color: #333;
      border-radius: 50%; 
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-right: 15px;
      transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    .gumb-nazaj:hover {
        background-color: #787878
    }

    /* ================================== */
    /* ===== NAMIZNI POGLED: ZAVIHKA V VRSTO (Nad 768px) ===== */
    /* ================================== */

    .profil-menu {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 1px solid #ccc;
      overflow-x: auto; 
      white-space: nowrap;
      flex-direction: row; 
    }

    .profil-zavihek {
      padding: 15px 25px;
      cursor: pointer;
      font-weight: bold;
      border-bottom: 3px solid transparent; 
      transition: 0.2s;
      text-align: center; 
      border-left: none; 
      border-right: none;
    }

    .profil-zavihek.active {
      border-bottom-color:none ; 
      color: #00979C;
    }

    .vsebina-zavihek {
      display: none;
    }

    .vsebina-zavihek.active {
      display: block;
    }

    .kartica-podatkov {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .kartica-formular label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 14px;
    }

    .kartica-formular input[type="text"],
    .kartica-formular input[type="month"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box; 
    }

    .flex-vrsta {
        display: flex;
        gap: 20px;
    }

    .flex-vrsta > div {
        flex: 1;
    }
    
    /* Stil za klikljive pretekle rezervacije (ko niso ocenjene) */
    .kartica-rezervacije.pretekla { 
        cursor: pointer; 
        transition: background-color 0.2s; 
    }
    .kartica-rezervacije.pretekla:hover { 
        background-color: #f0f0f0 !important; 
    }

    /* Stil za ≈æe ocenjene/preklicane rezervacije */
    .kartica-rezervacije.preklicano { 
        cursor: default !important;
        background-color: #f7f7f7 !important; 
        opacity: 0.85 !important; 
        border: 1px solid #ccc !important; 
        transition: none !important;
    }

    /* Stil za ocenjene rezervacije, brez moƒçne posivitve */
    .kartica-rezervacije.ocenjeno {
        cursor: default !important;
        background-color: #e8fdfb !important; 
        border: 1px solid #e8fdfb !important;
        border-left: 1px solid #e8fdfb !important; 
        transition: none !important;
    }
    
    /* Dodatni poudarek za preklicano */
    .kartica-rezervacije.preklicano {
        border-left: 5px solid orange !important;
    }
    
    /* Prepreƒçi hover efekt na ≈æe ocenjenih/preklicanih karticah */
    .kartica-rezervacije.ocenjeno:hover,
    .kartica-rezervacije.preklicano:hover {
        background-color: inherit !important; 
        box-shadow: none !important; 
        transform: none !important;
    }


    /* Stil za Modal (Okno za oceno) */
    #modal-ocena { 
        position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; 
        overflow: auto; background-color: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-vsebina { 
        background-color: #fefefe; 
        margin: 0; 
        padding: 30px; 
        border: 1px solid #888; 
        width: 90%; 
        max-width: 500px; 
        border-radius: 12px;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .zapri-gumb { 
        color: #aaa; 
        position: absolute; 
        top: 10px; 
        right: 20px;
        font-size: 32px; 
        font-weight: bold; 
        cursor: pointer;
        line-height: 1;
    }
    .zapri-gumb:hover, .zapri-gumb:focus { 
        color: black; 
        text-decoration: none; 
        cursor: pointer; 
    }
    
    #formular-ocena textarea {
        padding: 10px; 
        border-radius: 6px; 
        border: 1px solid #ccc; 
        width: 100%; 
        margin-top: 5px; 
        margin-bottom: 15px;
        box-sizing: border-box;
    }
    
    /* Stil za Sporoƒçilno polje */
    #sporocilo-ovoj {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        max-width: 350px;
        transition: opacity 0.3s, transform 0.3s;
        transform: translateY(-100px); 
        opacity: 0;
    }

    .sporocilo {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        font-weight: bold;
    }

    .sporocilo.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .sporocilo.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .sporocilo.visible {
        transform: translateY(0); 
        opacity: 1;
    }
    
    /* ======================================= */
    /* ===== STILI ZA ZVEZDICE (BREZ TEKSTA) ===== */
    /* ======================================= */
    .rating-wrapper {
        margin-bottom: 15px;
    }

    .star-rating-display {
        display: flex;
        align-items: center;
        gap: 10px; 
        padding: 5px 0;
        margin-top: 5px;
    }

    .star-group {
        display: flex;
        flex-direction: row-reverse; 
        unicode-bidi: bidi-override; 
    }

    .star-group span {
        font-size: 2.2em; 
        color: #ccc; 
        cursor: pointer;
        transition: color 0.2s ease-in-out;
        padding: 0 2px;
    }
    
    .star-group.active span,
    .star-group.hover span {
        color: #00979C;
    }
    
    /* ======================================= */


    
    /* ================================== */
    /* ===== PRAVILA ZA MOBILNE NAPRAVE (do 768px) ===== */
    /* ================================== */
    
    @media (max-width: 768px) {
        
        /* 1. GLAVA (HEADER) */
        .glava {
            justify-content: space-between; 
            flex-direction: row; 
            align-items: center; 
            padding: 10px 20px;
        }

        .gumb-nazaj {
            margin-right: 0;
        }

        /* 2. MENU ZAVIHKA (Vertikalno na mobilnem) */
        .profil-menu {
            flex-direction: column; 
            margin-bottom: 0; 
            border-bottom: none; 
            background-color: white;
            border: 1px solid white; 
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden; 
        }

        .profil-zavihek {
            width: 70%;
            padding: 5px 20px; 
            border-radius: 25px;
            text-align: left;
            border-bottom: 0px solid #f4f4f9; 
            border-right: none; 
            border-left: 3px solid transparent; 
            font-weight: normal; 
        }
        
        .profil-zavihek:last-child {
            border-bottom: none;
        }
        
        /* Aktivni zavihek (Mobilni) */
        .profil-zavihek.active {
            border-left-color: #00979C; 
            color: #f8f8f8;
            border-radius: 25px;
            background-color: #00979C;
            border-bottom-color: #00979C; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        /* 4. SKRIJEMO NASLOV */
        .vsebina-zavihek h3 {
             display: none; 
        }

        /* Prilagoditev za mobilne naprave */
        .flex-vrsta {
            flex-direction: column;
            gap: 0;
        }

        .kartica-formular input[type="text"],
        .kartica-formular input[type="month"] {
             margin-bottom: 5px; 
        }
    }
  </style>
</head>

<body>
  <header class="glava">
    
    <a href="index.html" class="gumb-nazaj">
        <i class="fas fa-arrow-left"></i>
    </a>

    <div class="akcije">
        </div>
  </header>

  <main>
    <div id="sporocilo-ovoj"></div>
    
    <section class="profil-sekcija">
      <h2 data-i18n="profile.title">Moj Uporabni≈°ki Profil</h2>
      
      <div class="profil-menu">
        <div class="profil-zavihek active" data-target="osnovni-podatki" data-i18n="profile.tab_data">Osebni Podatki</div>
        <div class="profil-zavihek" data-target="aktualne-rezervacije" data-i18n="profile.tab_current">Aktualne Rezervacije</div>
        <div class="profil-zavihek" data-target="zgodovina" data-i18n="profile.tab_history">Zgodovina Rezervacij</div>
        <div class="profil-zavihek" data-target="tocke-kartica" data-i18n="profile.tab_points_payment">Toƒçke in Plaƒçilo</div>
        <div class="profil-zavihek" data-target="obvestila" data-i18n="profile.tab_notifications">Obvestila</div>
      </div>

      <div class="vsebina-zavihek active" id="osnovni-podatki">
        <h3 data-i18n="profile.data_subtitle">Va≈°i podatki</h3>
        <div class="kartica-podatkov">
            <p id="profil-ime"><strong data-i18n="profile.name_label">Ime in priimek:</strong> <span class="placeholder-text">Nalaganje...</span></p>
            <p id="profil-email"><strong data-i18n="profile.email_label">E-po≈°ta:</strong> <span class="placeholder-text">Nalaganje...</span></p>
            <button data-i18n="profile.edit_button">Uredi podatke</button>
            
            <button class="gumb-odjava" id="gumb-odjava" data-i18n="header.logout">
                <i class="fas fa-sign-out-alt"></i> 
                Odjava
            </button>
        </div>
      </div>

      <div class="vsebina-zavihek" id="aktualne-rezervacije">
        <h3 data-i18n="profile.current_subtitle">Aktivne rezervacije</h3>
        
        <div class="qr-scan-ovoj">
            <button id="qr-scan-button" onclick="zacniSkeniranje()">
                <div class="icon-ovoj">
                    <i class="fas fa-camera"></i> 
                </div>
                <div class="text-ovoj">
                    <span class="main-text" data-i18n="profile.scan_qr_main_text">Potrdi Prihod</span>
                    <span class="sub-text" data-i18n="profile.scan_qr_sub_text">Skeniraj QR kodo in pridobi toƒçke</span>
                </div>
            </button>
            <p id="scan-status" style="margin-top: 10px; font-size: 14px; color: #555;"></p>
        </div>
        </div>

      <div class="vsebina-zavihek" id="zgodovina">
        <h3 data-i18n="profile.history_subtitle">Pretekle rezervacije</h3>
        </div>

      <div class="vsebina-zavihek" id="tocke-kartica">
        <h3 data-i18n="profile.points_payment_subtitle">Toƒçke in Plaƒçilna sredstva</h3>
        <div class="kartica-podatkov">
            <h4 data-i18n="profile.points_title">Va≈°e zbrane toƒçke</h4>
            <p id="tocke-status-prikaz" data-i18n="profile.points_status">Nalaganje toƒçk...</p>
        </div>

        <div class="kartica-podatkov">
            <h4 data-i18n="profile.card_title">Shranjena kreditna kartica</h4>
            <p id="kartica-info" data-i18n="profile.card_info">Visa konƒçnica: **** 1234</p>
            <button id="gumb-dodaj-kartico" data-i18n="profile.add_card_button">Dodaj/Posodobi kartico</button>
            
            <div id="kartica-formular" class="kartica-formular skrij-formular">
                <hr style="margin-top: 20px; border: 0; border-top: 1px solid #ccc;">
                <form id="formular-kartice">
                    <div>
                        <label for="stevilka-kartice">≈†tevilka kartice:</label>
                        <input type="text" id="stevilka-kartice" name="stevilka-kartice" placeholder="XXXX XXXX XXXX XXXX" required>
                    </div>

                    <div>
                        <label for="ime-na-kartici">Ime na kartici:</label>
                        <input type="text" id="ime-na-kartici" name="ime-na-kartici" placeholder="Ime in Priimek" required>
                    </div>

                    <div class="flex-vrsta">
                        <div>
                            <label for="veljavnost-kartice">Veljavnost (MM/LL):</label>
                            <input type="month" id="veljavnost-kartice" name="veljavnost-kartice" required>
                        </div>
                        <div>
                            <label for="cvv-kartice">CVV:</label>
                            <input type="text" id="cvv-kartice" name="cvv-kartice" placeholder="XXX" required pattern="\d{3,4}" title="CVV mora biti 3 ali 4 mestna ≈°tevilka">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button type="submit" data-i18n="profile.save_card_button">Shrani kartico</button>
                        <button type="button" class="gumb-odjava gumb-preklici" id="gumb-preklici-kartico" data-i18n="profile.cancel_button">Prekliƒçi</button>
                    </div>
                </form>
            </div>
            </div>
      </div>
      
      <div class="vsebina-zavihek" id="obvestila">
        <h3 data-i18n="profile.notifications_subtitle">Va≈°a obvestila</h3>
        <p>Tukaj se bodo prikazovala va≈°a sistemska obvestila (npr. potrditve in opomini rezervacij).</p>
      </div>
      
    </section>
    
    <div id="modal-ocena" class="skrij-modal">
        <div class="modal-vsebina">
            <span class="zapri-gumb">&times;</span>
            <h3 id="modal-ocena-naslov" data-i18n="profile.rate_title">Ocenite Restavracijo</h3>
            
            <form id="formular-ocena">
                <input type="hidden" id="ocena-restavracija-id" name="restavracijaId">
                <input type="hidden" id="ocena-rezervacija-id" name="rezervacijaId">

                <div class="rating-wrapper">
                    <div style="display:none;">
                   <label for="ocena-skrita" data-i18n="profile.rating_label">Ocena (1-5):</label>
<select id="ocena-skrita" name="ocena" required>
    <option value="5" data-i18n-ignore>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
    <option value="4" data-i18n-ignore>‚≠ê‚≠ê‚≠ê‚≠ê</option>
    <option value="3" data-i18n-ignore>‚≠ê‚≠ê‚≠ê</option>
    <option value="2" data-i18n-ignore>‚≠ê‚≠ê</option>
    <option value="1" data-i18n-ignore>‚≠ê</option>
</select>
                    </div>

                    <label data-i18n="profile.rating_label" style="display: block; margin-bottom: 5px;">Ocena (1-5):</label>
                    <div class="star-rating-display">
                        <div id="visual-rating" class="star-group" data-value="5">
                            <span data-value="5">‚òÖ</span>
                            <span data-value="4">‚òÖ</span>
                            <span data-value="3">‚òÖ</span>
                            <span data-value="2">‚òÖ</span>
                            <span data-value="1">‚òÖ</span>
                        </div>
                        </div>
                </div>
                <div>
                    <label for="komentar" data-i18n="profile.comment_label">Komentar:</label>
                    <textarea id="komentar" name="komentar" rows="4" placeholder="..."></textarea>
                </div>
                
                <button type="submit" data-i18n="profile.submit_review">Oddaj Oceno</button>
            </form>
        </div>
    </div>
    </main>
  <script>
        // ===========================================
        // API KONFIGURACIJA
        // ===========================================
        const BASE_URL = 'https://rentyo-gourmet-spletna-stran.onrender.com/api/';
        
        // API poti
        const PROFIL_API_URL = `${BASE_URL}auth/profil`;
        const AKTIVNE_REZERVACIJE_API_URL = `${BASE_URL}restavracije/uporabnik/aktivne`;
        const PRETEKLE_REZERVACIJE_API_URL = `${BASE_URL}restavracije/uporabnik/zgodovina`; 
        const PREKLIC_REZERVACIJE_API_URL = `${BASE_URL}restavracije/izbrisi_rezervacijo`;
        const ODDAJ_OCENO_API_URL = `${BASE_URL}restavracije/oceni`; 
        const QR_API_URL = `${BASE_URL}restavracije/potrdi_prihod`; 

        // ===========================================
        // Elementi modala in podatki
        // ===========================================
        const modalOcena = document.getElementById('modal-ocena');
        const modalZapriGumb = document.querySelector('#modal-ocena .zapri-gumb');
        const formularOcena = document.getElementById('formular-ocena');
        const ocenaRestavracijaIdInput = document.getElementById('ocena-restavracija-id'); 
        const ocenaRezervacijaIdInput = document.getElementById('ocena-rezervacija-id'); 
        const modalOcenaNaslov = document.getElementById('modal-ocena-naslov');
        const sporociloOvoj = document.getElementById('sporocilo-ovoj'); 
        
        // Elementi za zvezdice
        const visualRating = document.getElementById('visual-rating');
        const hiddenSelect = document.getElementById('ocena-skrita');
        
        // Elemente za prikaz podatkov
        const podatkiImeElement = document.getElementById('profil-ime'); 
        const podatkiEmailElement = document.getElementById('profil-email'); 
        const aktivneRezervacijeKontejner = document.getElementById('aktualne-rezervacije');
        const zgodovinaRezervacijKontejner = document.getElementById('zgodovina');
        const tockeStatusElement = document.getElementById('tocke-status-prikaz');
        
        // üöÄ Elementi za QR skeniranje (Referenca je globalna zaradi ponovnega renderiranja)
        let scanStatusElement = document.getElementById('scan-status');


        // ===========================================
        // 1. FUNKCIJA ZA PRIKAZ SPOROƒåIL
        // ===========================================
        
        /**
         * Prikazuje sporoƒçilo o uspehu ali napaki na vrhu strani.
         * @param {string} tip 'success' ali 'error'
         * @param {string} sporocilo Besedilo sporoƒçila
         */
        const prikaziSporocilo = (tip, sporocilo) => {
            const sporociloDiv = document.createElement('div');
            sporociloDiv.classList.add('sporocilo', tip);
            sporociloDiv.textContent = sporocilo;

            sporociloOvoj.appendChild(sporociloDiv);
            
            // Poka≈æi sporoƒçilo
            setTimeout(() => sporociloDiv.classList.add('visible'), 10);

            // Skrij in odstrani po 5 sekundah
            setTimeout(() => {
                sporociloDiv.classList.remove('visible');
                setTimeout(() => sporociloOvoj.removeChild(sporociloDiv), 300);
            }, 5000);
        };

        // ===========================================
        // 2. OSNOVNA LOGIKA ZA MENJAVO ZAVIHkov
        // ===========================================
        const zavihki = document.querySelectorAll(".profil-zavihek");
        const vsebine = document.querySelectorAll(".vsebina-zavihek");

        zavihki.forEach(zavihek => {
            zavihek.addEventListener("click", () => {
                zavihki.forEach(t => t.classList.remove("active"));
                vsebine.forEach(c => c.classList.remove("active"));
                zavihek.classList.add("active");
                const targetId = zavihek.getAttribute("data-target");
                document.getElementById(targetId).classList.add("active");
            });
        });


   // ===========================================
// üöÄ 2.5. LOGIKA ZA SKENIRANJE QR KODE (CAPACITOR INTEGRACIJA) üöÄ
// Uporablja stabilnej≈°i Community vtiƒçnik.
// ===========================================

// Preveri, ali se izvaja v Capacitor okolju
const isCapacitorApp = typeof Capacitor !== 'undefined' && Capacitor.isPluginAvailable('BarcodeScanner');

/**
 * Pomo≈æna funkcija za ƒçi≈°ƒçenje UI in prisilno ustavljanje kamere.
 * Zdaj vkljuƒçuje klic showBackground in stopScan za Community vtiƒçnik.
 */
const stopHighlight = async () => { 
     if (isCapacitorApp) {
         try {
             const { BarcodeScanner } = Capacitor.Plugins;
             
             // üö® KRITIƒåNO: Community vtiƒçnik zahteva to za ustavitev kamere.
             await BarcodeScanner.stopScan(); 
             
             // Community vtiƒçnik zahteva, da je ozadje spet vidno.
             await BarcodeScanner.showBackground();
             
         } catch (e) {
             console.log("BarcodeScanner.stopScan/showBackground failed, likely due to previous crash. Ignoring error.");
         }
         
         // Odstranitev celozaslonskega premaza (ƒçe se je uporabil za UI)
         document.body.classList.remove('barcode-scanner-active');
     }
}


/**
 * 1. Po≈°lje restavracijaId na stre≈ænik za potrditev prihoda in dodelitev toƒçk.
 * (Ta funkcija ostaja veƒçinoma enaka, popravljen je le klic stopHighlight.)
 * @param {string} restavracijaId ID restavracije, skeniran iz QR kode.
 */
const potrdiPrihodNaStre≈æniku = async (restavracijaId) => {
    if (!zeton) {
        prikaziSporocilo('error', i18next.t('profile.auth_required'));
        return;
    }
    
    if (scanStatusElement) {
         scanStatusElement.textContent = i18next.t('profile.status_sending');
         scanStatusElement.style.color = '#575757';
    }

    try {
        const response = await fetch(QR_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${zeton}` 
            },
            body: JSON.stringify({ restavracijaId })
        });

        const data = await response.json();

        if (response.ok) {
            prikaziSporocilo('success', data.msg);
            
            if (scanStatusElement) {
                const statusMsg = i18next.t('profile.status_success', { points: data.noveTocke }) || data.msg;
                scanStatusElement.textContent = statusMsg;
                scanStatusElement.style.color = 'green';
            }
            
            // 1. Posodobitev toƒçk in profila
            naloziPodatkeProfila(); 
            
            // 2. Premik rezervacije: Ponovno nalo≈æi aktivne (izgine/posodobi status)
            naloziAktivneRezervacije();
            
            // 3. Premik rezervacije: Ponovno nalo≈æi pretekle (se prika≈æe)
            naloziPretekleRezervacije();

        } else {
            console.error("Napaka pri potrditvi prihoda:", data);
            const errorMsg = i18next.t('profile.status_error') + `: ${data.msg || response.statusText}`;
            prikaziSporocilo('error', errorMsg);
             if (scanStatusElement) {
                scanStatusElement.textContent = errorMsg;
                scanStatusElement.style.color = 'red';
            }
        }
    } catch (error) {
        console.error("Kritiƒçna napaka pri potrditvi prihoda:", error);
        prikaziSporocilo('error', i18next.t('profile.server_error'));
         if (scanStatusElement) {
            scanStatusElement.textContent = i18next.t('profile.server_error_short') || 'Napaka stre≈ænika.';
            scanStatusElement.style.color = 'red';
        }
    }
    // üö® Klic stopHighlight mora poƒçakati na ustavitev kamere.
    await stopHighlight(); 
};


/**
 * 2. Za≈æene Community BarcodeScanner.
 */
const zacniSkeniranje = async () => {
    if (!isCapacitorApp) {
        prikaziSporocilo('error', i18next.t('profile.scan_unavailable') || 'Skeniranje ni na voljo.');
        return;
    }
    
    const { BarcodeScanner } = Capacitor.Plugins;

    try {
        // --- üö® KRITIƒåNA SPREMEMBA 1: Preverjanje in zahtevanje dovoljenja ---
        
        // Community vtiƒçnik (za razliko od ML Kit) uporablja get/requestPermission()
        let status = await BarcodeScanner.checkPermission();

        if (status.granted === false) {
            status = await BarcodeScanner.requestPermission();
        }
        
        if (status.granted === false) {
             const msg = i18next.t('profile.permission_denied') || 'Dovoljenje za kamero zavrnjeno.';
             prikaziSporocilo('error', msg);
             if (scanStatusElement) scanStatusElement.textContent = msg;
             
             stopHighlight(); 
             return;
        }
        
        // --- üö® KRITIƒåNA SPREMEMBA 2: Community vtiƒçnik potrebuje transparentno ozadje ---
        
        // Naredi ozadje WebViewa transparentno, da se skozi njega vidi kamera.
        await BarcodeScanner.hideBackground();
        
        // Ta klic pustimo, saj generira celozaslonski premaz/ozadje:
        document.body.classList.add('barcode-scanner-active'); 
        
        if (scanStatusElement) {
            scanStatusElement.textContent = i18next.t('profile.status_scanning') || 'Skeniranje v teku...';
            scanStatusElement.style.color = '#1BC0BB';
        }

        // --- üö® KRITIƒåNA SPREMEMBA 3: Community vtiƒçnik deluje s poslu≈°anjem dogodkov ---
        
        // Community vtiƒçnik uporablja startScan z zanko (ne odpira nove Activity)
        const result = await BarcodeScanner.startScan();
        
        // Ustavitev je v Community vtiƒçniku izrecno potrebna
        await stopHighlight(); 
        
        // ***************************************************************
        // KRITIƒåNA OBRAVNAVA: Preveri, ali je rezultat definiran in ima vsebino
        // ***************************************************************
        if (!result || result.hasContent === false) {
            // To se zgodi, ƒçe je skeniranje prekinjeno ali vtiƒçnik ni na≈°el vsebine.
            const msg = i18next.t('profile.scan_cancelled') || 'Skeniranje preklicano.';
            prikaziSporocilo('error', msg);
            if (scanStatusElement) {
                scanStatusElement.textContent = msg;
                scanStatusElement.style.color = 'orange';
            }
            return;
        }


        // Logika se nadaljuje le, ƒçe je result definiran in ima vsebino:
        const restavracijaId = result.content; 
        
        // Validacija formata: 24 znakov (MongoDB ObjectId)
        if (restavracijaId.length !== 24 || !restavracijaId.match(/^[0-9a-fA-F]{24}$/)) {
            const msg = i18next.t('profile.invalid_qr_format') || 'Neveljaven format QR kode. Skenirajte ƒçisto besedilo (ID restavracije).';
            prikaziSporocilo('error', msg);
             if (scanStatusElement) scanStatusElement.textContent = msg;
            return;
        }

        potrdiPrihodNaStre≈æniku(restavracijaId);
        
        
    } catch (error) {
        // Obravnava kritiƒçnih napak
        
        if (error.message && error.message.includes('permission')) {
             prikaziSporocilo('error', i18next.t('profile.permission_denied') || 'Dovoljenje za kamero zavrnjeno.');
        } else {
             prikaziSporocilo('error', `${i18next.t('profile.scanner_error') || 'Napaka skenerja'}: ${error.message}`);
        }
       
        console.error('Napaka pri Community BarcodeScannerju:', error);
        
        await stopHighlight();
    }
};

// ===========================================
// 3. AVTENTIKACIJA IN NALAGANJE PODATKOV
// ===========================================

const zeton = localStorage.getItem('zeton');

const updateHeader = () => {
    if (!zeton) {
        window.location.href = 'index.html';
    }
};

const odjava = (e) => {
    if (e) e.preventDefault();
    localStorage.removeItem('zeton'); 
    localStorage.removeItem('jeLastnik'); 
    window.location.href = 'index.html'; 
};

const posodobiPrikazPodatka = (element, labelKey, value) => {
    if (element) {
        const label = typeof i18next !== 'undefined' ? i18next.t(labelKey) : labelKey; 
        let span = element.querySelector('.placeholder-text');
        
        element.innerHTML = `<strong>${label}:</strong> `; 
        
        if(!span) {
            span = document.createElement('span');
            span.className = 'placeholder-text';
        }
        span.textContent = value;
        element.appendChild(span);
    }
};

        const naloziPodatkeProfila = async () => {
            if (!zeton) return;

            const gumbOdjava = document.getElementById('gumb-odjava');
            if (gumbOdjava) {
                gumbOdjava.addEventListener('click', odjava);
            }

            try {
                const response = await fetch(PROFIL_API_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}` 
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const uporabnik = data.uporabnik || data; 

                    if (uporabnik && uporabnik.ime && uporabnik.email) {
                        posodobiPrikazPodatka(podatkiImeElement, 'profile.name_label', uporabnik.ime);
                        posodobiPrikazPodatka(podatkiEmailElement, 'profile.email_label', uporabnik.email);
                        
                        if (tockeStatusElement && uporabnik.tockeZvestobe !== undefined) {
                            const tocke = uporabnik.tockeZvestobe;
                            const tockeZaEuro = 45; 
                            const vrednostVPopustu = (tocke / tockeZaEuro).toFixed(2); 
                            
                            const statusText = i18next.t('profile.points_status_dynamic', {
                                count: tocke, 
                                popust: vrednostVPopustu 
                            });

                            tockeStatusElement.innerHTML = statusText; 

                        } else if (tockeStatusElement) {
                             tockeStatusElement.textContent = i18next.t('profile.points_loading');
                        }
                        
                    } else {
                        console.error("Podatki uporabnika so nepopolni ali v napaƒçni obliki.", data);
                    }
                    
                } else if (response.status === 401 || response.status === 403) {
                    console.error("Avtorizacija neuspe≈°na:", response.status);
                    odjava();
                } else {
                    console.error("Napaka pri nalaganju profila:", response.status);
                }

            } catch (error) {
                console.error("Napaka pri komunikaciji z backendom:", error);
            }
        };

        // ===========================================
        // 4. LOGIKA ZA REZERVACIJE IN OCENJEVANJE 
        // ===========================================
        
        const prekliciRezervacijo = async (restavracijaId, mizaId, rezervacijaId) => {
            
            if (!window.confirm(i18next.t('profile.cancel_confirmation'))) return;
            
            try {
                const response = await fetch(PREKLIC_REZERVACIJE_API_URL, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}`
                    },
                    body: JSON.stringify({ 
                        restavracijaId, 
                        mizaId, 
                        rezervacijaId 
                    })
                });

                if (response.ok) {
                    prikaziSporocilo('success', i18next.t('profile.cancel_success'));
                    naloziAktivneRezervacije(); 
                    naloziPretekleRezervacije();
                } else {
                    const errorData = await response.json().catch(() => ({ msg: response.statusText }));
                    console.error("SERVER RESPONSE ERROR on cancellation:", response.status, errorData);
                    prikaziSporocilo('error', `${i18next.t('profile.cancel_error')}: ${errorData.msg || response.statusText}. Prosimo, preverite konzolo za podrobnosti.`);
                }
            } catch (error) {
                console.error("Napaka pri preklicu rezervacije:", error);
                prikaziSporocilo('error', i18next.t('profile.server_error'));
            }
        };

        const renderRezervacije = (rezervacije, kontejnerElement, jeAktivnaLista) => {
            const h3 = kontejnerElement.querySelector('h3');
            kontejnerElement.innerHTML = '';
            if (h3) kontejnerElement.appendChild(h3);
            
            // üöÄ Popravek: Dodajanje QR dela nazaj v aktivne rezervacije
            if (jeAktivnaLista) {
                const qrOvoj = document.createElement('div');
                qrOvoj.classList.add('qr-scan-ovoj');
                qrOvoj.innerHTML = `
                   <button id="qr-scan-button" onclick="zacniSkeniranje()">
                       <div class="icon-ovoj">
                           <i class="fas fa-camera"></i> 
                       </div>
                       <div class="text-ovoj">
                            <span class="main-text" data-i18n="profile.scan_qr_main_text">${i18next.t('profile.scan_qr_main_text')}</span>
                            <span class="sub-text" data-i18n="profile.scan_qr_sub_text">${i18next.t('profile.scan_qr_sub_text')}</span>
                        </div>
                   </button>
                    <p id="scan-status" style="margin-top: 10px; font-size: 14px; color: #555;"></p>
                `;
                kontejnerElement.appendChild(qrOvoj);
                
                // Ponovno nastavimo status gumba za QR skeniranje, ƒçe nismo v Capacitor okolju
                 if (!isCapacitorApp) {
                     const scanButton = qrOvoj.querySelector('#qr-scan-button');
                     const statusElement = qrOvoj.querySelector('#scan-status');
                     if (scanButton) scanButton.style.display = 'none';
                     if (statusElement) {
                         statusElement.textContent = i18next.t('profile.scan_unavailable') || 'Skeniranje je na voljo samo v mobilni aplikaciji.';
                         statusElement.style.color = 'orange';
                     }
                }
                
                // Ponovno nastavimo referenco na element statusa, saj smo ga na novo ustvarili
                scanStatusElement = qrOvoj.querySelector('#scan-status');

            }


            if (!rezervacije || rezervacije.length === 0) {
                const sporocilo = jeAktivnaLista 
                    ? i18next.t('profile.no_current_reservations')
                    : i18next.t('profile.no_history_reservations');
                
                const p = document.createElement('p');
                p.textContent = sporocilo;
                p.style.padding = '15px 20px';
                p.style.backgroundColor = '#f8f8f8';
                p.style.borderRadius = '8px';
                kontejnerElement.appendChild(p);
                return;
            }

            rezervacije.forEach(rez => {
                const kartica = document.createElement('div');
                kartica.classList.add('kartica-rezervacije', 'kartica-podatkov'); 
                kartica.style.padding = '15px 20px';
                kartica.style.marginBottom = '10px';
                kartica.style.border = '1px solid #ccc';
                kartica.style.borderRadius = '8px';
                kartica.style.display = 'flex';
                kartica.style.flexDirection = 'row'; 
                kartica.style.justifyContent = 'space-between'; 
                kartica.style.alignItems = 'center';
                kartica.style.gap = '15px';
                kartica.style.backgroundColor = '#fff';
                
                const currentStatus = rez.status?.toUpperCase() || 'POTRJENO'; // Vzemi status rezervacije

                if (!jeAktivnaLista) {
                    
                    const isCancelled = currentStatus === 'PREKLICANO'; 
                    const jeZeOcenjeno = rez.ocenjeno || false; 
                    
                    kartica.classList.add('pretekla'); 
                    
                    if (isCancelled) {
                        kartica.classList.add('preklicano'); 
                    } else if (jeZeOcenjeno) {
                        kartica.classList.add('ocenjeno'); 
                    } 
                    
                    // Omogoƒçi ocenjevanje samo, ƒçe ni preklicano in ≈°e ni ocenjeno
                    if (!jeZeOcenjeno && !isCancelled && currentStatus === 'POTRJENO_PRIHOD') { 
                        kartica.style.cursor = 'pointer';
                        kartica.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'BUTTON') { 
                                odpriModalOcena(rez.restavracijaId, rez._id, rez.ime_restavracije);
                            }
                        });
                    } else {
                        kartica.style.cursor = 'default';
                    }
                    
                    kartica.dataset.restavracijaId = rez.restavracijaId;
                    kartica.dataset.rezervacijaId = rez._id; 
                    kartica.dataset.imeRestavracije = rez.ime_restavracije;
                    
                }
                
                // --- 1. Podatki o rezervaciji ---
                const cas = rez.cas_rezervacije;
                const ura = Math.floor(cas); 
                const minute = Math.round((cas - ura) * 60); 
                const casIzpis = `${ura.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

                const podatkiDiv = document.createElement('div');
                podatkiDiv.classList.add('rezervacija-podatki');
                
             let htmlContent = `
                    <p style="font-weight: bold; margin: 0;">${rez.ime_restavracije}</p>
                    
                    <p style="margin: 5px 0 0 0; display: flex; align-items: center;" class="text-sm">
                        
                        <span class="flex items-center mr-6"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle text-gray-500 mr-2"> 
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg> 
                            <span>${rez.datum_rezervacije}</span>
                        </span>
                        
                        <span class="flex items-center mr-6 ml-6"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle text-gray-500 mr-2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg> 
                            <span>${casIzpis}</span>
                        </span>
                        
                        <span class="flex items-center ml-6"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle text-gray-500 mr-2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <span>${rez.stevilo_oseb}</span>
                        </span>
                    </p>
                `;

                // Logika za status v zgodovini
                if (!jeAktivnaLista) {
                    const isCancelled = currentStatus === 'PREKLICANO'; 
                    const jeZeOcenjeno = kartica.classList.contains('ocenjeno'); 
                    
                    let statusTextHtml = '';

                    if (isCancelled) {
                        statusTextHtml = `<p style="margin: 5px 0 0 0; font-weight: bold; color: orange;">${i18next.t('profile.status_cancelled')}</p>`;
                    } else if (jeZeOcenjeno) {
                        statusTextHtml = `<p style="margin: 5px 0 0 0; font-weight: bold; color: #575757;">
                                            <i class="fas fa-check-circle" style="color: #20c0bd;"></i> 
                                            ${i18next.t('profile.status_rated')}
                                        </p>`;
                    } else if (currentStatus === 'POTRJENO_PRIHOD') { // Ko ni preklicano in ≈°e ni ocenjeno
                         statusTextHtml = `<p style="margin: 5px 0 0 0; font-weight: bold; color:#20c0bd;">
                                            ${i18next.t('profile.status_rate_now')}
                                        </p>`;
                    } else {
                         statusTextHtml = `<p style="margin: 5px 0 0 0; font-weight: bold; color:#575757;">
                                            ${i18next.t('profile.status_completed')}
                                        </p>`;
                    }

                    htmlContent += statusTextHtml;
                }
                
                podatkiDiv.innerHTML = htmlContent;
                kartica.appendChild(podatkiDiv);
                
                // --- 2. LOGIKA ZA AKTIVNE REZERVACIJE (Potrjeno ali Prekliƒçi) ---
                if (jeAktivnaLista) {
                    // POPRAVEK: Preverjamo status 'POTRJENO_PRIHOD', saj stre≈ænik to nastavi po QR skeniranju.
                    const jePotrjeno = currentStatus === 'POTRJENO_PRIHOD'; 

                    if (jePotrjeno) {
                        // Renderiraj 'Potrjeno' status namesto gumba (gumb Prekliƒçi se skrije)
                        const statusDiv = document.createElement('div');
                        statusDiv.classList.add('status-potrjeno');
                        statusDiv.textContent = i18next.t('profile.status_confirmed') || 'Potrjeno'; 
                        kartica.appendChild(statusDiv);
                        
                    } else {
                        // Renderiraj 'Prekliƒçi' gumb (ƒçe je status 'POTRJENO' ali kateri koli drug ne-potrjen status)
                        const preklicGumb = document.createElement('button');
                        preklicGumb.classList.add('gumb-preklici');
                        preklicGumb.textContent = i18next.t('profile.cancel_button');
                        preklicGumb.style.flexShrink = '0'; 

                        const mizaId = rez.mizaId; 
                        
                        preklicGumb.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            prekliciRezervacijo(rez.restavracijaId, mizaId, rez._id);
                        });
                        
                        kartica.appendChild(preklicGumb);
                    }
                }

                kontejnerElement.appendChild(kartica);
            });
        };

        const naloziAktivneRezervacije = async () => {
            try {
                const response = await fetch(AKTIVNE_REZERVACIJE_API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${zeton}` }
                });

                if (response.ok) {
                    const rezervacije = await response.json();
                    renderRezervacije(rezervacije, aktivneRezervacijeKontejner, true);
                } else if (response.status === 401 || response.status === 403) {
                    renderRezervacije([], aktivneRezervacijeKontejner, true);
                } else {
                    console.error("Napaka pri nalaganju aktivnih rezervacij:", response.status);
                    aktivneRezervacijeKontejner.innerHTML += `<p style="color: red;">${i18next.t('profile.loading_error')}</p>`;
                }
            } catch (error) {
                console.error("Kritiƒçna napaka pri nalaganju aktivnih rezervacij:", error);
            }
        };

        const naloziPretekleRezervacije = async () => {
            try {
                const response = await fetch(PRETEKLE_REZERVACIJE_API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${zeton}` }
                });

                if (response.ok) {
                    const rezervacije = await response.json();
                    renderRezervacije(rezervacije, zgodovinaRezervacijKontejner, false);
                } else if (response.status === 401 || response.status === 403) {
                    renderRezervacije([], zgodovinaRezervacijKontejner, false);
                } else {
                    console.error("Napaka pri nalaganju preteklih rezervacij:", response.status);
                    zgodovinaRezervacijKontejner.innerHTML += `<p style="color: red;">${i18next.t('profile.loading_error')}</p>`;
                }
            } catch (error) {
                console.error("Kritiƒçna napaka pri nalaganju preteklih rezervacij:", error);
            }
        };


        // ===========================================
        // 5. LOGIKA ZA OCENJEVANJE IN ZVEZDICE 
        // ===========================================
        
        // ... (Vsa logika za Modal in Star Rating ostane enaka) ...
        
        /**
         * Odpre modal za ocenjevanje in napolni polja
         */
        const odpriModalOcena = (restavracijaId, rezervacijaId, imeRestavracije) => {
            modalOcenaNaslov.textContent = `${i18next.t('profile.rate_title')} ${imeRestavracije}`;
            ocenaRestavracijaIdInput.value = restavracijaId; 
            ocenaRezervacijaIdInput.value = rezervacijaId; 
            
            // Poƒçisti vnosna polja in inicializiraj zvezdice
            document.getElementById('ocena-skrita').value = '5'; // Nastavi privzeto na 5
            document.getElementById('komentar').value = '';
            
            // KLJUƒåNO: Inicializacija prikaza zvezdic
            updateStarRating(5); 

            modalOcena.classList.remove('skrij-modal');
        };

        /**
         * Zapre modal za ocenjevanje
         */
        const zapriModalOcena = () => {
            modalOcena.classList.add('skrij-modal');
            // Ponovno nalo≈æi zgodovino, da se posodobi status ocenjene rezervacije
            naloziPretekleRezervacije(); 
        };

        /**
         * Po≈°lje oceno in komentar na API
         */
        const oddajOcenoInKomentar = async (e) => {
            e.preventDefault();

            const restavracijaId = ocenaRestavracijaIdInput.value;
            const rezervacijaId = ocenaRezervacijaIdInput.value;
            const ocena = document.getElementById('ocena-skrita').value;
            const komentar = document.getElementById('komentar').value;
            
            if (!restavracijaId || !rezervacijaId || !ocena) {
                prikaziSporocilo('error', i18next.t('profile.review_missing_data'));
                return;
            }

            const urlZKlicem = `${ODDAJ_OCENO_API_URL}/${restavracijaId}`;

            try {
                const response = await fetch(urlZKlicem, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}`
                    },
                    body: JSON.stringify({ 
                        restavracijaId, 
                        rezervacijaId, 
                        ocena: parseInt(ocena, 10), 
                        komentar 
                    })
                });

                if (response.ok) {
                    prikaziSporocilo('success', i18next.t('profile.review_success'));
                    zapriModalOcena();
                } else {
                    const errorData = await response.json().catch(() => ({ msg: response.statusText }));
                    console.error("SERVER RESPONSE ERROR on review submission (Preverite ID-je!):", response.status, errorData);
                    prikaziSporocilo('error', `${i18next.t('profile.review_error')}: ${errorData.msg || response.statusText}. Prosimo, preverite konzolo za podrobnosti.`);
                }

            } catch (error) {
                console.error("Napaka pri oddaji ocene (Network Error):", error);
                prikaziSporocilo('error', i18next.t('profile.server_error'));
            }
        };

        
        // LOGIKA ZA INTERAKTIVNE ZVEZDICE
        
        /**
         * Posodobi vizualni prikaz zvezdic in skrito polje.
         */
        const updateStarRating = (value, isHover = false) => {
            const stars = visualRating.querySelectorAll('span');
            const numericValue = parseInt(value);

            if (!isHover) {
                document.getElementById('ocena-skrita').value = value;
                visualRating.setAttribute('data-value', value);
            }

            stars.forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                
                if (starValue <= numericValue) {
                    star.style.color = '#20c0bd'; 
                } else {
                    star.style.color = '#ccc'; 
                }
            });
        };

        const starRatingLogic = () => {
            if (!visualRating) return;

            // Poslu≈°alec za klik (Trajna izbira)
            visualRating.addEventListener('click', (event) => {
                if (event.target.tagName === 'SPAN') {
                    const value = event.target.getAttribute('data-value');
                    if (value) {
                        updateStarRating(value); // Uveljavi trajno izbiro
                    }
                }
            });

            // Poslu≈°alec za premik mi≈°ke (Vizualni povratni odziv - Hover)
            visualRating.addEventListener('mouseover', (event) => {
                if (event.target.tagName === 'SPAN') {
                    const hoverValue = event.target.getAttribute('data-value');
                    if (hoverValue) {
                        updateStarRating(hoverValue, true); // Prikaz samo pri lebdenju
                    }
                }
            });

            // Poslu≈°alec za zapustitev obmoƒçja zvezdic (Vrne na izbrano vrednost)
            visualRating.addEventListener('mouseleave', () => {
                const currentValue = visualRating.getAttribute('data-value') || '5';
                updateStarRating(currentValue);
            });
            
        };

        // Event listenerji za modal (Zapiranje)
        if(modalZapriGumb) {
            modalZapriGumb.addEventListener('click', zapriModalOcena);
        }
        window.addEventListener('click', (event) => {
            if (event.target === modalOcena) {
                zapriModalOcena();
            }
        });
        if(formularOcena) {
             formularOcena.addEventListener('submit', oddajOcenoInKomentar);
        }

        // ===========================================
        // 6. i18next IN ZAGON
        // ===========================================

        const updateContent = () => {
          document.querySelectorAll("[data-i18n]").forEach((el) => {
            const key = el.getAttribute("data-i18n");
            
            // Logika za QR gumb in druge nestrukturirane prevode (preskoƒçimo)
            if (key === 'profile.scan_qr_main_text' || key === 'profile.scan_qr_sub_text') {
                 return;
            }

            // Splo≈°na logika prevajanja
            if (el.tagName === 'BUTTON' || el.classList.contains('profil-zavihek')) {
                const ikona = el.querySelector('.fas');
                el.textContent = i18next.t(key);
                if (ikona) el.prepend(ikona);
            } else {
                el.textContent = i18next.t(key);
            }
          });
          
          document.title = i18next.t("app.profile_title");

          const imeLabel = i18next.t('profile.name_label');
          const emailLabel = i18next.t('profile.email_label');

          if (podatkiImeElement) {
              const content = podatkiImeElement.querySelector('span')?.textContent || '';
              podatkiImeElement.innerHTML = `<strong>${imeLabel}:</strong> <span class="placeholder-text">${content}</span>`;
          }
          if (podatkiEmailElement) {
              const content = podatkiEmailElement.querySelector('span')?.textContent || '';
              podatkiEmailElement.innerHTML = `<strong>${emailLabel}:</strong> <span class="placeholder-text">${content}</span>`;
          }
          
          if (modalOcenaNaslov) {
             modalOcenaNaslov.textContent = i18next.t('profile.rate_title');
          }
        };

        const loadLanguage = () => {
            return localStorage.getItem('i18nextLng') || 'sl'; 
        };
        
        i18next.use(i18nextHttpBackend).init(
            {
                lng: loadLanguage(), 
                fallbackLng: "sl",
                backend: { loadPath: "./i18n/{{lng}}.json" }, 
                interpolation: {
                    escapeValue: false, 
                }
            },
            (err) => {
                if (err) console.error("i18next napaka pri nalaganju: ", err);
                
                updateContent();
                updateHeader();
                
                // ZAGON NALAGANJA PODATKOV IN REZERVACIJ
                naloziPodatkeProfila(); 
                naloziAktivneRezervacije(); 
                naloziPretekleRezervacije(); 
                
                // ZAGON LOGIKE ZA ZVEZDICE
                starRatingLogic(); 
                
                // Logika: Prikaz/skrivanje formularja za kartico
                const gumbDodajKartico = document.getElementById('gumb-dodaj-kartico');
                const formularKartice = document.getElementById('kartica-formular');
                const gumbPrekliciKartico = document.getElementById('gumb-preklici-kartico');
                
                // POƒåISTIMO STATIƒåNO VSEBINO za naknadno renderiranje z renderRezervacije
                aktivneRezervacijeKontejner.innerHTML = `<h3 data-i18n="profile.current_subtitle">${i18next.t('profile.current_subtitle')}</h3>`;
                zgodovinaRezervacijKontejner.innerHTML = `<h3 data-i18n="profile.history_subtitle">${i18next.t('profile.history_subtitle')}</h3>`;


                if (gumbDodajKartico && formularKartice && gumbPrekliciKartico) {
                    
                    const preklopiPrikazFormularja = () => {
                        formularKartice.classList.toggle('skrij-formular');
                        const jePrikazan = !formularKartice.classList.contains('skrij-formular');
                        gumbDodajKartico.textContent = i18next.t(jePrikazan ? 'profile.hide_card_button' : 'profile.add_card_button');
                    };

                    gumbDodajKartico.addEventListener('click', preklopiPrikazFormularja);
                    gumbPrekliciKartico.addEventListener('click', preklopiPrikazFormularja);

                    const form = document.getElementById('formular-kartice');
                    if (form) {
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            prikaziSporocilo('success', i18next.t('profile.card_saved'));
                            preklopiPrikazFormularja();
                        });
                    }
                }
                
                // ƒåe nismo v Capacitor okolju, skrijemo QR gumb, ko se nalo≈æi jezik
                 if (!isCapacitorApp) {
                     const scanButton = document.getElementById('qr-scan-button');
                     if (scanButton) {
                         scanButton.style.display = 'none';
                     }
                     if (scanStatusElement) {
                         scanStatusElement.textContent = i18next.t('profile.scan_unavailable') || 'Skeniranje je na voljo samo v mobilni aplikaciji.';
                         scanStatusElement.style.color = 'orange';
                     }
                }
                
            }
        );
    </script>
</body>
</html>