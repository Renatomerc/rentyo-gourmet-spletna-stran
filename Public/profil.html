<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="app.profile_title">Moj Profil - Gourmet & Experience</title>

  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.11.5/i18next.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-http-backend/2.5.2/i18nextHttpBackend.min.js"></script>
<style>
    /* SPECIFIƒåEN CSS ZA PROFIL */
    .profil-sekcija {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ===== GLAVA IN SKRIVANJE ELEMENTOV ===== */
    .logotip {
        display: none !important; /* SKRIJ LOGOTIP NA VSEH NAPRAVAH */
    }
    .jezik-ovoj {
        display: none !important; /* SKRIJ IZBIRNIK JEZIKA NA VSEH NAPRAVAH */
    }
    
    /* üÜï NOVI STIL: Skrije element, privzeto za formular kartice */
    .skrij-formular {
        display: none;
    }


    /* ===== STIIL ZA GUMBE V GLAVI (HEADER) IN RAZMIKE (PRENESENO Z INDEX.HTML) ===== */
    
    /* Skupni stil za gumbe (Nazaj, Profil, Odjava) */
    .gumb-prijava, 
    .gumb-profil, 
    .gumb-odjava, /* DODAN TUDI GUMB ODJAVA, ƒçeprav je zdaj v vsebini */
    .kartica-podatkov button { /* STIL ZA VSE GUMBE V KARTICAH */
      display: inline-flex;
      align-items: center;
      gap: 5px; 
      padding: 8px 15px; /* Poveƒçan padding za gumbe v vsebini */
      border-radius: 20px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      white-space: nowrap;
      font-size: 14px;
      cursor: pointer; /* Dodan kazalec */
      margin-top: 15px; /* Dodan razmik od prej≈°njih elementov v kartici */
                /* üëá DODAJTE TA DVA PRAVILA ZA ODSTRANITEV MODREGA POUDARKA NA MOBILNIH NAPRAVAH üëá */
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    /* üëÜ ZAKLJUƒåEK DODATKOV üëÜ */
    }

    /* Stil za "Prijava" in "Moj Profil" (Primarni gumb) */
    .gumb-prijava,
    .gumb-profil,
    .kartica-podatkov button:not(.gumb-odjava):not(.gumb-preklici) /* Vsi gumbi razen odjava IN prekliƒçi */ {
      background-color: #575757;
      color: white;
      border: 1px solid #575757;
                /* üëá DODAJTE TA DVA PRAVILA ZA ODSTRANITEV MODREGA POUDARKA NA MOBILNIH NAPRAVAH üëá */
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    /* üëÜ ZAKLJUƒåEK DODATKOV üëÜ */
    }

    .gumb-prijava:hover, 
    .gumb-profil:hover,
    .kartica-podatkov button:not(.gumb-odjava):not(.gumb-preklici):hover {
      background-color: #787878;
      border-color: #787878;
                /* üëá DODAJTE TA DVA PRAVILA ZA ODSTRANITEV MODREGA POUDARKA NA MOBILNIH NAPRAVAH üëá */
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    /* üëÜ ZAKLJUƒåEK DODATKOV üëÜ */
    }
    
    /* Stil za "Odjava" (Sekundarni/Outline gumb) */
    .gumb-odjava {
      background-color: transparent; 
      color: #3e3e3e; /* Rdeƒça barva za odjavo */
      border: 1px solid #3e3e3e;
      margin-left: 10px; /* Razmik, ƒçe je zraven drugega gumba */
                /* üëá DODAJTE TA DVA PRAVILA ZA ODSTRANITEV MODREGA POUDARKA NA MOBILNIH NAPRAVAH üëá */
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    /* üëÜ ZAKLJUƒåEK DODATKOV üëÜ */
    }
    
    .gumb-odjava:hover {
      background-color: #d3d3d3; /* Svetlo rdeƒça podlaga */
      color: #424242;
      border-color: #424242;
    }

    /* üÜï NOVI STIL: Gumb za Preklic (Poudarjena rdeƒça za nevarnost) */
    .gumb-preklici {
      background-color: #e74c3c; /* Moƒçna rdeƒça barva za nevarnost/preklic */
      color: white;
      font-size: 14px;
      border: 1px solid #e74c3c;
      padding: 8px 15px; /* Poveƒçan padding za gumbe v vsebini */
      border-radius: 20px;
      margin-left: 10px; /* Razmik od prej≈°njih elementov */
      /* Prekrije margin-top iz generiƒçnega stila, da je poravnan z besedilom */
      margin-top: 0; 
      align-self: flex-start; /* Za poravnavo v liniji s textom, ƒçe je v flex kontejnerju */
      cursor: pointer; /* Dodan kazalec */
                /* üëá DODAJTE TA DVA PRAVILA ZA ODSTRANITEV MODREGA POUDARKA NA MOBILNIH NAPRAVAH üëá */
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    /* üëÜ ZAKLJUƒåEK DODATKOV üëÜ */
    }
    
    .gumb-preklici:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }

    /* OVOJ ZA PROFIL: Poskrbi za poravnavo in razmik (dihanje) */
    .profil-ovoj {
        display: flex; 
        align-items: center;
        gap: 10px; 
    }

    /* ===== STYLING ZA GUMB NAZAJ (NI SPREMENJENO) ===== */
    .gumb-nazaj {
      text-decoration: none;
      color: white;
      background-color: #333;
      border-radius: 50%; /* Oblika kroga */
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-right: 15px;
      transition: background-color 0.2s;
                /* üëá DODAJTE TA DVA PRAVILA ZA ODSTRANITEV MODREGA POUDARKA NA MOBILNIH NAPRAVAH üëá */
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    /* üëÜ ZAKLJUƒåEK DODATKOV üëÜ */
    }
    
    .gumb-nazaj:hover {
        background-color: #787878
    }

    /* ================================== */
    /* ===== NAMIZNI POGLED: ZAVIHKA V VRSTO (Nad 768px) ===== */
    /* ================================== */

    .profil-menu {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 1px solid #ccc;
      overflow-x: auto; 
      white-space: nowrap;
      flex-direction: row; /* Poskrbimo, da je horizontalno na namizju */
    }

    .profil-zavihek {
      padding: 15px 25px;
      cursor: pointer;
      font-weight: bold;
      border-bottom: 3px solid transparent; /* Aktivna ƒçrta spodaj */
      transition: 0.2s;
      text-align: center; /* Vsebina v zavihku na sredini */
      border-left: none; /* Odstrani morebitno levi rob iz mobilnega */
      border-right: none;
    }

    .profil-zavihek.active {
      border-bottom-color:none ; /* Aktivna barva za spodnji rob */
      color: #20c0bd;
    }

    .vsebina-zavihek {
      display: none;
    }

    .vsebina-zavihek.active {
      display: block;
    }

    /* Dodajte stajling za obliko vsebine, kartic, formularjev itd. */
    .kartica-podatkov {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    /* Stilizacija elementov formularja za lep≈°i videz */
    .kartica-formular label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 14px;
    }

    .kartica-formular input[type="text"],
    .kartica-formular input[type="month"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box; /* Kljuƒçno za padding! */
    }

    .flex-vrsta {
        display: flex;
        gap: 20px;
    }

    .flex-vrsta > div {
        flex: 1;
    }
    
    /* ================================== */
    /* ===== PRAVILA ZA MOBILNE NAPRAVE (do 768px) ===== */
    /* ================================== */
    
    @media (max-width: 768px) {
        
        /* 1. GLAVA (HEADER) */
        .glava {
            justify-content: space-between; 
            flex-direction: row; 
            align-items: center; 
            padding: 10px 20px;
        }

        .gumb-nazaj {
            margin-right: 0;
        }

        /* 2. MENU ZAVIHKA (Vertikalno na mobilnem) */
        .profil-menu {
            flex-direction: column; /* Kljuƒçno: zavihki vertikalno */
            margin-bottom: 0; /* Odstranimo spodnji rob */
            border-bottom: none; /* Odstranimo spodnjo ƒçrto */
            /* Stil menija kot kontejnerja */
            background-color: #f4f4f9;
            border: 1px solid #f4f4f9; /* Lahek rob okoli celotnega menija */
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden; /* Odstrani scrollbar */
        }

        .profil-zavihek {
            width: 70%;
            padding: 5px 20px; /* Malo veƒçji padding za bolj≈°e tapkanje */
            border-radius: 25px;
            text-align: left;
            border-bottom: 1px solid #f4f4f9; /* Loƒçilna ƒçrta med zavihki */
            border-right: none; 
            border-left: 3px solid transparent; /* Priprava za aktivni levi rob */
            font-weight: normal; /* Manj poudarjen font na mobilnem */
        }
        
        /* Odstranimo zadnjo loƒçilno ƒçrto */
        .profil-zavihek:last-child {
            border-bottom: none;
        }
        
        /* Aktivni zavihek (Mobilni) */
        .profil-zavihek.active {
            border-left-color: #4edaa9; /* Aktivna barva na levi */
            color: #333;
            border-radius: 25px;
            background-color: #4edaa9;
            border-bottom-color: #4edaa9; /* Da skrije spodnjo ƒçrto pod sabo */
                      /* üëá DODAJTE TA DVA PRAVILA ZA ODSTRANITEV MODREGA POUDARKA NA MOBILNIH NAPRAVAH üëá */
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    /* üëÜ ZAKLJUƒåEK DODATKOV üëÜ */
        }
        
        /* 4. SKRIJEMO NASLOV, da ne pride do podvajanja, ƒçe je vsebina zavihka oƒçitna */
        .vsebina-zavihek h3 {
             display: none; 
        }

        /* Prilagoditev za mobilne naprave */
        .flex-vrsta {
            flex-direction: column;
            gap: 0;
        }

        .kartica-formular input[type="text"],
        .kartica-formular input[type="month"] {
             margin-bottom: 5px; /* Manj razmika na mobilnem */
        }
    }
  </style>
</head>

<body>
  <header class="glava">
    
    <a href="index.html" class="gumb-nazaj">
        <i class="fas fa-arrow-left"></i>
    </a>

    <div class="akcije">
        </div>
  </header>

  <main>
    <section class="profil-sekcija">
      <h2 data-i18n="profile.title">Moj Uporabni≈°ki Profil</h2>
      
      <div class="profil-menu">
        <div class="profil-zavihek active" data-target="osnovni-podatki" data-i18n="profile.tab_data">Osebni Podatki</div>
        <div class="profil-zavihek" data-target="aktualne-rezervacije" data-i18n="profile.tab_current">Aktualne Rezervacije</div>
        <div class="profil-zavihek" data-target="zgodovina" data-i18n="profile.tab_history">Zgodovina Rezervacij</div>
        <div class="profil-zavihek" data-target="tocke-kartica" data-i18n="profile.tab_points_payment">Toƒçke in Plaƒçilo</div>
        <div class="profil-zavihek" data-target="obvestila" data-i18n="profile.tab_notifications">Obvestila</div>
      </div>

      <div class="vsebina-zavihek active" id="osnovni-podatki">
        <h3 data-i18n="profile.data_subtitle">Va≈°i podatki</h3>
        <div class="kartica-podatkov">
            <p id="profil-ime"><strong data-i18n="profile.name_label">Ime in priimek:</strong> <span class="placeholder-text">Nalaganje...</span></p>
            <p id="profil-email"><strong data-i18n="profile.email_label">E-po≈°ta:</strong> <span class="placeholder-text">Nalaganje...</span></p>
            <button data-i18n="profile.edit_button">Uredi podatke</button>
            
            <button class="gumb-odjava" id="gumb-odjava" data-i18n="header.logout">
                <i class="fas fa-sign-out-alt"></i> 
                Odjava
            </button>
        </div>
      </div>

      <div class="vsebina-zavihek" id="aktualne-rezervacije">
        <h3 data-i18n="profile.current_subtitle">Aktivne rezervacije</h3>
        <p>Restavracija Pri Mariji, 27. 11. 2025 ob 19:00 (2 osebi) <button class="gumb-preklici" data-i18n="profile.cancel_button">Prekliƒçi</button></p>
      </div>

      <div class="vsebina-zavihek" id="zgodovina">
        <h3 data-i18n="profile.history_subtitle">Pretekle rezervacije</h3>
        <p>Restavracija XXX, 1. 10. 2025 ob 18:30 (4 osebe)</p>
        <p>Restavracija YYY, 15. 9. 2025 ob 20:00 (2 osebi)</p>
      </div>

      <div class="vsebina-zavihek" id="tocke-kartica">
        <h3 data-i18n="profile.points_payment_subtitle">Toƒçke in Plaƒçilna sredstva</h3>
        <div class="kartica-podatkov">
            <h4 data-i18n="profile.points_title">Va≈°e zbrane toƒçke</h4>
            <p data-i18n="profile.points_status">Trenutno stanje: <strong>450 toƒçk</strong> (Dovolj za 10‚Ç¨ popusta)</p>
        </div>

        <div class="kartica-podatkov">
            <h4 data-i18n="profile.card_title">Shranjena kreditna kartica</h4>
            <p id="kartica-info" data-i18n="profile.card_info">Visa konƒçnica: **** 1234</p>
            <button id="gumb-dodaj-kartico" data-i18n="profile.add_card_button">Dodaj/Posodobi kartico</button>
            
            <div id="kartica-formular" class="kartica-formular skrij-formular">
                <hr style="margin-top: 20px; border: 0; border-top: 1px solid #ccc;">
                <form id="formular-kartice">
                    <div>
                        <label for="stevilka-kartice">≈†tevilka kartice:</label>
                        <input type="text" id="stevilka-kartice" name="stevilka-kartice" placeholder="XXXX XXXX XXXX XXXX" required>
                    </div>

                    <div>
                        <label for="ime-na-kartici">Ime na kartici:</label>
                        <input type="text" id="ime-na-kartici" name="ime-na-kartici" placeholder="Ime in Priimek" required>
                    </div>

                    <div class="flex-vrsta">
                        <div>
                            <label for="veljavnost-kartice">Veljavnost (MM/LL):</label>
                            <input type="month" id="veljavnost-kartice" name="veljavnost-kartice" required>
                        </div>
                        <div>
                            <label for="cvv-kartice">CVV:</label>
                            <input type="text" id="cvv-kartice" name="cvv-kartice" placeholder="XXX" required pattern="\d{3,4}" title="CVV mora biti 3 ali 4 mestna ≈°tevilka">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button type="submit" data-i18n="profile.save_card_button">Shrani kartico</button>
                        <button type="button" class="gumb-odjava gumb-preklici" id="gumb-preklici-kartico" data-i18n="profile.cancel_button">Prekliƒçi</button>
                    </div>
                </form>
            </div>
            </div>
      </div>
      
      <div class="vsebina-zavihek" id="obvestila">
        <h3 data-i18n="profile.notifications_subtitle">Va≈°a obvestila</h3>
        <p>Tukaj se bodo prikazovala va≈°a sistemska obvestila (npr. potrditve in opomini rezervacij).</p>
      </div>
      
    </section>
  </main>

  <footer class="noga">
    <div class="noga-avtorske-pravice">
      ¬© 2025 Rentyo Gourmet. Vse pravice pridr≈æane.
    </div>
  </footer>

<script>
        // ===========================================
        // API KONFIGURACIJA
        // ===========================================
        const BASE_URL = 'https://rentyo-gourmet-spletna-stran.onrender.com/api/';
        
        // üî¥ KLJUƒåNI POPRAVEK: Popravljene in dodane API poti
        const PROFIL_API_URL = `${BASE_URL}auth/profil`;
        const AKTIVNE_REZERVACIJE_API_URL = `${BASE_URL}restavracije/uporabnik/aktivne`;
        const ZGODOVINA_REZERVACIJ_API_URL = `${BASE_URL}restavracije/uporabnik/zgodovina`;
        const PREKLIC_REZERVACIJE_API_URL = `${BASE_URL}restavracije/izbrisi_rezervacijo`; // Uporabimo DELETE pot

        // ===========================================
        // 1. OSNOVNA LOGIKA ZA MENJAVO ZAVIHkov (NESPREMENJENO)
        // ===========================================
        const zavihki = document.querySelectorAll(".profil-zavihek");
        const vsebine = document.querySelectorAll(".vsebina-zavihek");

        zavihki.forEach(zavihek => {
            zavihek.addEventListener("click", () => {
                zavihki.forEach(t => t.classList.remove("active"));
                vsebine.forEach(c => c.classList.remove("active"));
                zavihek.classList.add("active");
                const targetId = zavihek.getAttribute("data-target");
                document.getElementById(targetId).classList.add("active");
            });
        });

        // ===========================================
        // 2. AVTENTIKACIJA IN NALAGANJE PODATKOV
        // ===========================================

        const zeton = localStorage.getItem('zeton');
        const akcijeDiv = document.querySelector('.akcije');
        
        // Elemente za prikaz podatkov
        const podatkiImeElement = document.getElementById('profil-ime'); 
        const podatkiEmailElement = document.getElementById('profil-email'); 
        // üÜï NOVO: Kontejnerji za rezervacije
        const aktivneRezervacijeKontejner = document.getElementById('aktualne-rezervacije');
        const zgodovinaRezervacijKontejner = document.getElementById('zgodovina');

        /**
         * Prikaz gumba za odjavo in gumba nazaj
         */
        const updateHeader = () => {
            if (!zeton) {
                // ƒåe ni ≈æetona, uporabnika preusmerimo nazaj
                window.location.href = 'index.html';
            }
        };
        
        /**
         * Logika za odjavo
         */
        const odjava = (e) => {
            if (e) e.preventDefault();
            localStorage.removeItem('zeton'); 
            localStorage.removeItem('jeLastnik'); 
            window.location.href = 'index.html'; 
        };
        
        /**
         * Posodobi prikaz imena in priimka/e-po≈°te
         * @param {HTMLElement} element - Element, ki ga posodabljamo
         * @param {string} labelKey - i18n kljuƒç za labelo (npr. 'profile.name_label')
         * @param {string} value - Dejanska vrednost (ime ali e-po≈°ta)
         */
        const posodobiPrikazPodatka = (element, labelKey, value) => {
            if (element) {
                const label = typeof i18next !== 'undefined' ? i18next.t(labelKey) : labelKey; 
                let span = element.querySelector('.placeholder-text');
                
                element.innerHTML = `<strong>${label}:</strong> `; 
                
                if(!span) {
                    span = document.createElement('span');
                    span.className = 'placeholder-text';
                }
                span.textContent = value;
                element.appendChild(span);
            }
        };

        /**
         * Pokliƒçe za≈°ƒçiten endpoint in napolni osebne podatke
         */
        const naloziPodatkeProfila = async () => {
            if (!zeton) return;

            // Dodajanje event listenerja za gumb ODJAVA
            const gumbOdjava = document.getElementById('gumb-odjava');
            if (gumbOdjava) {
                gumbOdjava.addEventListener('click', odjava);
            }

            try {
                const response = await fetch(PROFIL_API_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}` 
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const uporabnik = data.uporabnik || data; 

                    if (uporabnik && uporabnik.ime && uporabnik.email) {
                        posodobiPrikazPodatka(podatkiImeElement, 'profile.name_label', uporabnik.ime);
                        posodobiPrikazPodatka(podatkiEmailElement, 'profile.email_label', uporabnik.email);
                        
                    } else {
                        console.error("Podatki uporabnika so nepopolni ali v napaƒçni obliki.", data);
                    }
                    
                } else if (response.status === 401 || response.status === 403) {
                    console.error("Avtorizacija neuspe≈°na:", response.status);
                    odjava();
                } else {
                    console.error("Napaka pri nalaganju profila:", response.status);
                }

            } catch (error) {
                console.error("Napaka pri komunikaciji z backendom:", error);
            }
        };

        // ===========================================
        // 3. LOGIKA ZA REZERVACIJE (NOVO)
        // ===========================================
        
        /**
         * Klic API-ja za preklic rezervacije
         */
        const prekliciRezervacijo = async (restavracijaId, mizaId, rezervacijaId) => {
            if (!confirm(i18next.t('profile.cancel_confirmation'))) return;
            
            try {
                const response = await fetch(PREKLIC_REZERVACIJE_API_URL, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}`
                    },
                    body: JSON.stringify({ 
                        restavracijaId, 
                        mizaId, 
                        rezervacijaId 
                    })
                });

                if (response.ok) {
                    alert(i18next.t('profile.cancel_success'));
                    // Ponovno nalaganje obeh seznamov po uspe≈°nem preklicu
                    naloziAktivneRezervacije(); 
                    naloziZgodovinoRezervacij();
                } else {
                    const errorData = await response.json();
                    alert(`${i18next.t('profile.cancel_error')}: ${errorData.msg || response.statusText}`);
                }
            } catch (error) {
                console.error("Napaka pri preklicu rezervacije:", error);
                alert(i18next.t('profile.server_error'));
            }
        };

        /**
         * Pomo≈æna funkcija za renderiranje rezervacij
         * üí• POPRAVLJENO: Ustvarjanje ustrezne HTML strukture za "kartice"
         */
        const renderRezervacije = (rezervacije, kontejnerElement, jeAktivnaLista) => {
            // Ponastavi vsebino kontejnerja (hrani samo h3 naslov)
            const h3 = kontejnerElement.querySelector('h3');
            kontejnerElement.innerHTML = '';
            if (h3) kontejnerElement.appendChild(h3);

            if (!rezervacije || rezervacije.length === 0) {
                const sporocilo = jeAktivnaLista 
                    ? i18next.t('profile.no_current_reservations')
                    : i18next.t('profile.no_history_reservations');
                
                const p = document.createElement('p');
                p.textContent = sporocilo;
                p.style.padding = '15px 20px';
                p.style.backgroundColor = '#f8f8f8';
                p.style.borderRadius = '8px';
                kontejnerElement.appendChild(p);
                return;
            }

            rezervacije.forEach(rez => {
                // üí• POPRAVEK: Uporabimo <div> za bolj≈°o strukturo 'kartice'
                const kartica = document.createElement('div');
                kartica.classList.add('kartica-rezervacije'); 
                kartica.classList.add('kartica-podatkov'); 
                kartica.style.padding = '15px 20px';
                kartica.style.marginBottom = '10px';
                kartica.style.border = '1px solid #ccc';
                kartica.style.borderRadius = '8px';
                kartica.style.display = 'flex';
                kartica.style.flexDirection = 'row'; /* Osnovni prikaz v vrsti */
                kartica.style.justifyContent = 'space-between'; /* Razmak med vsebino in gumbom */
                kartica.style.alignItems = 'center';
                kartica.style.gap = '15px';
                kartica.style.backgroundColor = '#fff';
                
                // --- 1. Podatki o rezervaciji (Text Content) ---

                // Formatiranje ƒçasa (npr. 19.5 -> 19:30)
                const cas = rez.cas_rezervacije;
                const ura = Math.floor(cas); // 19.5 -> 19
                // Izbolj≈°ana pretvorba decimal v minute:
                const minute = Math.round((cas - ura) * 60); 
                const casIzpis = `${ura.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

                const podatkiDiv = document.createElement('div');
                podatkiDiv.classList.add('rezervacija-podatki');
                
                let htmlContent = `
                    <p style="font-weight: bold; margin: 0;">${rez.ime_restavracije}</p>
                    <p style="margin: 5px 0 0 0;">${rez.datum_rezervacije} ob ${casIzpis} (${rez.stevilo_oseb} oseb)</p>
                `;

                if (!jeAktivnaLista) {
                    // Za zgodovino dodamo status
                    const statusText = rez.status === 'PREKLICANO' 
                        ? i18next.t('profile.status_cancelled') 
                        : i18next.t('profile.status_completed');
                    const color = rez.status === 'PREKLICANO' ? 'orange' : 'grey';
                    htmlContent += `<p style="margin: 5px 0 0 0; font-weight: bold; color: ${color};">[${statusText}]</p>`;
                }
                
                podatkiDiv.innerHTML = htmlContent;
                kartica.appendChild(podatkiDiv);
                
                // --- 2. Gumb za preklic (Samo za aktivne) ---
                if (jeAktivnaLista) {
                    const preklicGumb = document.createElement('button');
                    preklicGumb.classList.add('gumb-preklici');
                    preklicGumb.textContent = i18next.t('profile.cancel_button');
                    preklicGumb.style.flexShrink = '0'; // Ne skrƒçi se

                    // Dummy ID, ker mizaId ≈°e vedno ni v agregaciji
                    const mizaIdDummy = '000000000000000000000000'; 
                    
                    preklicGumb.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        console.log(`[FRONTEND] Poskus preklica: RezervacijaID: ${rez._id}, RestavracijaID: ${rez.restavracijaId}, MizaID: ${mizaIdDummy}`);
                        prekliciRezervacijo(rez.restavracijaId, mizaIdDummy, rez._id);
                    });
                    
                    kartica.appendChild(preklicGumb);
                }

                kontejnerElement.appendChild(kartica);
            });
        };

        /**
         * Klic API-ja za aktivne rezervacije
         */
        const naloziAktivneRezervacije = async () => {
            try {
                const response = await fetch(AKTIVNE_REZERVACIJE_API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${zeton}` }
                });

                if (response.ok) {
                    const rezervacije = await response.json();
                    renderRezervacije(rezervacije, aktivneRezervacijeKontejner, true);
                } else if (response.status === 401 || response.status === 403) {
                    renderRezervacije([], aktivneRezervacijeKontejner, true);
                    console.error("Dostop do aktivnih rezervacij zavrnjen.");
                } else {
                    console.error("Napaka pri nalaganju aktivnih rezervacij:", response.status);
                    aktivneRezervacijeKontejner.innerHTML += `<p style="color: red;">${i18next.t('profile.loading_error')}</p>`;
                }
            } catch (error) {
                console.error("Kritiƒçna napaka pri nalaganju aktivnih rezervacij:", error);
            }
        };

        /**
         * Klic API-ja za zgodovino rezervacij
         */
        const naloziZgodovinoRezervacij = async () => {
            try {
                const response = await fetch(ZGODOVINA_REZERVACIJ_API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${zeton}` }
                });

                if (response.ok) {
                    const rezervacije = await response.json();
                    renderRezervacije(rezervacije, zgodovinaRezervacijKontejner, false);
                } else if (response.status === 401 || response.status === 403) {
                    renderRezervacije([], zgodovinaRezervacijKontejner, false);
                    console.error("Dostop do zgodovine rezervacij zavrnjen.");
                } else {
                    console.error("Napaka pri nalaganju zgodovine rezervacij:", response.status);
                    zgodovinaRezervacijKontejner.innerHTML += `<p style="color: red;">${i18next.t('profile.loading_error')}</p>`;
                }
            } catch (error) {
                console.error("Kritiƒçna napaka pri nalaganju zgodovine rezervacij:", error);
            }
        };


        // ===========================================
        // 4. i18next IN ZAGON
        // ===========================================

        const updateContent = () => {
          document.querySelectorAll("[data-i18n]").forEach((el) => {
            const key = el.getAttribute("data-i18n");
            if (el.tagName === 'BUTTON' || el.classList.contains('profil-zavihek')) {
                const ikona = el.querySelector('.fas');
                el.textContent = i18next.t(key);
                if (ikona) el.prepend(ikona);
            } else {
                el.textContent = i18next.t(key);
            }
          });
          
          document.title = i18next.t("app.profile_title");

          // Ponovno posodobimo labele po nalaganju jezika
          const imeLabel = i18next.t('profile.name_label');
          const emailLabel = i18next.t('profile.email_label');

          if (podatkiImeElement) {
              const content = podatkiImeElement.querySelector('span')?.textContent || '';
              podatkiImeElement.innerHTML = `<strong>${imeLabel}:</strong> <span class="placeholder-text">${content}</span>`;
          }
          if (podatkiEmailElement) {
              const content = podatkiEmailElement.querySelector('span')?.textContent || '';
              podatkiEmailElement.innerHTML = `<strong>${emailLabel}:</strong> <span class="placeholder-text">${content}</span>`;
          }
          
        };

        const loadLanguage = () => {
            return localStorage.getItem('i18nextLng') || 'sl'; 
        };
        
        i18next.use(i18nextHttpBackend).init(
            {
                lng: loadLanguage(), 
                fallbackLng: "sl",
                backend: { loadPath: "./i18n/{{lng}}.json" }, 
            },
            (err) => {
                if (err) console.error("i18next napaka pri nalaganju: ", err);
                
                updateContent();
                updateHeader();
                
                // üöÄ ZAGON NALAGANJA PODATKOV IN REZERVACIJ
                naloziPodatkeProfila(); 
                naloziAktivneRezervacije(); // üÜï KLJUƒåNO
                naloziZgodovinoRezervacij(); // üÜï KLJUƒåNO
                
                // üÜï KLJUƒåNA LOGIKA: Prikaz/skrivanje formularja za kartico
                const gumbDodajKartico = document.getElementById('gumb-dodaj-kartico');
                const formularKartice = document.getElementById('kartica-formular');
                const gumbPrekliciKartico = document.getElementById('gumb-preklici-kartico');
                
                // POƒåISTIMO STATIƒåNO VSEBINO v "Aktualne rezervacije" in "Zgodovina rezervacij"
                // saj jo bomo dinamiƒçno nalo≈æili
                aktivneRezervacijeKontejner.innerHTML = `<h3 data-i18n="profile.current_subtitle">Aktivne rezervacije</h3>`;
                zgodovinaRezervacijKontejner.innerHTML = `<h3 data-i18n="profile.history_subtitle">Pretekle rezervacije</h3>`;


                if (gumbDodajKartico && formularKartice && gumbPrekliciKartico) {
                    
                    const preklopiPrikazFormularja = () => {
                        formularKartice.classList.toggle('skrij-formular');
                        const jePrikazan = !formularKartice.classList.contains('skrij-formular');
                        gumbDodajKartico.textContent = i18next.t(jePrikazan ? 'profile.hide_card_button' : 'profile.add_card_button');
                    };

                    gumbDodajKartico.addEventListener('click', preklopiPrikazFormularja);
                    gumbPrekliciKartico.addEventListener('click', preklopiPrikazFormularja);

                    const form = document.getElementById('formular-kartice');
                    if (form) {
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            console.log('Podatki kartice shranjeni! (Implementacija po≈°iljanja na stre≈ænik ≈°e sledi)');
                            preklopiPrikazFormularja();
                        });
                    }
                }
            }
        );
    </script>
</body>
</html>