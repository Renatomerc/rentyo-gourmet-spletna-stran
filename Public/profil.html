<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="app.profile_title">Moj Profil - Gourmet & Experience</title>

  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.11.5/i18next.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-http-backend/2.5.2/i18nextHttpBackend.min.js"></script>
<style>
    /* SPECIFIƒåEN CSS ZA PROFIL */
    /* ... (ostali ne-konfliktni stili ostajajo enaki) ... */

    .profil-sekcija {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* ===== GLAVA IN SKRIVANJE ELEMENTOV ===== */
    .logotip {
        display: none !important; 
    }
    .jezik-ovoj {
        display: none !important; 
    }
    
    /* SKRIVANJE ELEMENTOV */
    .skrij-formular {
        display: none;
    }
    /* Modal za oceno na zaƒçetku ni viden */
    .skrij-modal { 
        display: none !important; 
    }


    /* ===== STIIL ZA GUMBE ... (ostali gumbi in header stili) ===== */
    
    .gumb-prijava, 
    .gumb-profil, 
    .gumb-odjava, 
    .kartica-podatkov button,
    .modal-vsebina button[type="submit"] { /* Dodan stil za gumb v modal-u */
      display: inline-flex;
      align-items: center;
      gap: 5px; 
      padding: 8px 15px; 
      border-radius: 20px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      white-space: nowrap;
      font-size: 14px;
      cursor: pointer; 
      margin-top: 15px; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    /* Primarni stil za gumbe */
    .gumb-prijava,
    .gumb-profil,
    .kartica-podatkov button:not(.gumb-odjava):not(.gumb-preklici),
    .modal-vsebina button[type="submit"] /* Stil za gumb Oddaj oceno */ {
      background-color: #575757;
      color: white;
      border: 1px solid #575757;
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    .gumb-prijava:hover, 
    .gumb-profil:hover,
    .kartica-podatkov button:not(.gumb-odjava):not(.gumb-preklici):hover,
    .modal-vsebina button[type="submit"]:hover {
      background-color: #787878;
      border-color: #787878;
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    /* Sekundarni/Outline gumb */
    .gumb-odjava {
      background-color: transparent; 
      color: #3e3e3e; 
      border: 1px solid #3e3e3e;
      margin-left: 10px; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    .gumb-odjava:hover {
      background-color: #d3d3d3; 
      color: #424242;
      border-color: #424242;
    }

    /* Gumb za Preklic (Nevarnost) */
    .gumb-preklici {
      background-color: #e74c3c; 
      color: white;
      font-size: 14px;
      border: 1px solid #e74c3c;
      padding: 8px 15px; 
      border-radius: 20px;
      margin-left: 10px; 
      margin-top: 0; 
      align-self: flex-start; 
      cursor: pointer; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    .gumb-preklici:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }

    /* OVOJ ZA PROFIL */
    .profil-ovoj {
        display: flex; 
        align-items: center;
        gap: 10px; 
    }

    /* GUMB NAZAJ */
    .gumb-nazaj {
      text-decoration: none;
      color: white;
      background-color: #333;
      border-radius: 50%; 
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      margin-right: 15px;
      transition: background-color 0.2s;
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    .gumb-nazaj:hover {
        background-color: #787878
    }

    /* ================================== */
    /* ===== NAMIZNI POGLED: ZAVIHKA V VRSTO (Nad 768px) ===== */
    /* ================================== */

    .profil-menu {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 1px solid #ccc;
      overflow-x: auto; 
      white-space: nowrap;
      flex-direction: row; 
    }

    .profil-zavihek {
      padding: 15px 25px;
      cursor: pointer;
      font-weight: bold;
      border-bottom: 3px solid transparent; 
      transition: 0.2s;
      text-align: center; 
      border-left: none; 
      border-right: none;
    }

    .profil-zavihek.active {
      border-bottom-color:none ; 
      color: #20c0bd;
    }

    .vsebina-zavihek {
      display: none;
    }

    .vsebina-zavihek.active {
      display: block;
    }

    .kartica-podatkov {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .kartica-formular label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 14px;
    }

    .kartica-formular input[type="text"],
    .kartica-formular input[type="month"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box; 
    }

    .flex-vrsta {
        display: flex;
        gap: 20px;
    }

    .flex-vrsta > div {
        flex: 1;
    }
    
    /* Stil za klikljive pretekle rezervacije (ko niso ocenjene) */
    .kartica-rezervacije.pretekla { 
        cursor: pointer; 
        transition: background-color 0.2s; 
    }
    .kartica-rezervacije.pretekla:hover { 
        background-color: #f0f0f0 !important; 
    }

    /* üîë KLJUƒåNI POPRAVEK: Stil za ≈æe ocenjene/preklicane rezervacije */
    .kartica-rezervacije.preklicano { 
        cursor: default !important;
        background-color: #f7f7f7 !important; /* Ne≈æno siva */
        opacity: 0.85 !important; /* Rahla zmanj≈°ana prosojnost, da se loƒçi */
        border: 1px solid #ccc !important; 
        transition: none !important;
    }

    /* üåü NOVO: Stil za ocenjene rezervacije, brez moƒçne posivitve */
    .kartica-rezervacije.ocenjeno {
        cursor: default !important;
        background-color: #e8fdfb !important; /* Svetlo sivo ozadje */
        border: 1px solid #e8fdfb !important;
        border-left: 1px solid #e8fdfb !important; /* ZELENA/CYAN levo obroba */
        transition: none !important;
    }
    
    /* Dodatni poudarek za preklicano */
    .kartica-rezervacije.preklicano {
        border-left: 5px solid orange !important;
    }
    
    /* üîë KLJUƒåNI POPRAVEK: Prepreƒçi hover efekt na ≈æe ocenjenih/preklicanih karticah */
    .kartica-rezervacije.ocenjeno:hover,
    .kartica-rezervacije.preklicano:hover {
        background-color: inherit !important; /* Ohranimo barvo, ki je ≈æe nastavljena zgoraj */
        box-shadow: none !important; 
        transform: none !important;
    }


    /* üÜï NOVO: Stil za Modal (Okno za oceno) */
    /* ... (ostali ne-konfliktni stili) ... */
    #modal-ocena { 
        position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; 
        overflow: auto; background-color: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-vsebina { 
        background-color: #fefefe; 
        margin: 0; 
        padding: 30px; 
        border: 1px solid #888; 
        width: 90%; 
        max-width: 500px; 
        border-radius: 12px;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .zapri-gumb { 
        color: #aaa; 
        position: absolute; 
        top: 10px; 
        right: 20px;
        font-size: 32px; 
        font-weight: bold; 
        cursor: pointer;
        line-height: 1;
    }
    .zapri-gumb:hover, .zapri-gumb:focus { 
        color: black; 
        text-decoration: none; 
        cursor: pointer; 
    }
    /* ODSTRANJENI STILI ZA SELECT in VSTAVLJENI NOVI ZA ZVEZDICE */
    #formular-ocena textarea {
        padding: 10px; 
        border-radius: 6px; 
        border: 1px solid #ccc; 
        width: 100%; 
        margin-top: 5px; 
        margin-bottom: 15px;
        box-sizing: border-box;
    }
    
    /* üåü NOVO: Stil za Sporoƒçilno polje */
    #sporocilo-ovoj {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        max-width: 350px;
        transition: opacity 0.3s, transform 0.3s;
        transform: translateY(-100px); /* Skrito zgoraj */
        opacity: 0;
    }

    .sporocilo {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        font-weight: bold;
    }

    .sporocilo.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .sporocilo.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .sporocilo.visible {
        transform: translateY(0); /* Prikazano */
        opacity: 1;
    }
    
    /* ======================================= */
    /* ===== üöÄ NOVI STILI ZA ZVEZDICE üöÄ ===== */
    /* ======================================= */
    .rating-wrapper {
        margin-bottom: 15px;
    }

    .star-rating-display {
        display: flex;
        align-items: center;
        gap: 10px; 
        padding: 5px 0;
        margin-top: 5px;
    }

    .star-group {
        display: flex;
        flex-direction: row-reverse; /* Obrnemo, da je 5 na levi */
        unicode-bidi: bidi-override; /* Za pravilno delovanje obratne smeri */
    }

    .star-group span {
        font-size: 2.2em; 
        color: #ccc; /* Privzeta barva (Siva/Neaktivna) */
        cursor: pointer;
        transition: color 0.2s ease-in-out;
        padding: 0 2px;
    }
    
    /* Barva aktivnih in pri lebdenju zvezdic */
    .star-group.active span,
    .star-group.hover span {
        color: #20c0bd; /* ‚ú® ≈ΩELENA BARVA: #20c0bd ‚ú® */
    }

    .rating-text {
        font-weight: 500;
        min-width: 100px; 
    }
    /* ======================================= */


    
    /* ================================== */
    /* ===== PRAVILA ZA MOBILNE NAPRAVE (do 768px) ===== */
    /* ================================== */
    
    @media (max-width: 768px) {
        
        /* 1. GLAVA (HEADER) */
        /* ... (stili za glavo) ... */
        .glava {
            justify-content: space-between; 
            flex-direction: row; 
            align-items: center; 
            padding: 10px 20px;
        }

        .gumb-nazaj {
            margin-right: 0;
        }

        /* 2. MENU ZAVIHKA (Vertikalno na mobilnem) */
        /* ... (stili za menu) ... */
        .profil-menu {
            flex-direction: column; 
            margin-bottom: 0; 
            border-bottom: none; 
            background-color: white;
            border: 1px solid white; 
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden; 
        }

        .profil-zavihek {
            width: 70%;
            padding: 5px 20px; 
            border-radius: 25px;
            text-align: left;
            border-bottom: 0px solid #f4f4f9; 
            border-right: none; 
            border-left: 3px solid transparent; 
            font-weight: normal; 
        }
        
        .profil-zavihek:last-child {
            border-bottom: none;
        }
        
        /* Aktivni zavihek (Mobilni) */
        .profil-zavihek.active {
            border-left-color: #1BC0BB; 
            color: #f8f8f8;
            border-radius: 25px;
            background-color: #1BC0BB;
            border-bottom-color: #1BC0BB; 
    -webkit-tap-highlight-color: transparent;
    -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        /* 4. SKRIJEMO NASLOV */
        .vsebina-zavihek h3 {
             display: none; 
        }

        /* Prilagoditev za mobilne naprave */
        .flex-vrsta {
            flex-direction: column;
            gap: 0;
        }

        .kartica-formular input[type="text"],
        .kartica-formular input[type="month"] {
             margin-bottom: 5px; 
        }
    }
  </style>
</head>

<body>
  <header class="glava">
    
    <a href="index.html" class="gumb-nazaj">
        <i class="fas fa-arrow-left"></i>
    </a>

    <div class="akcije">
        </div>
  </header>

  <main>
    <div id="sporocilo-ovoj"></div>
    
    <section class="profil-sekcija">
      <h2 data-i18n="profile.title">Moj Uporabni≈°ki Profil</h2>
      
      <div class="profil-menu">
        <div class="profil-zavihek active" data-target="osnovni-podatki" data-i18n="profile.tab_data">Osebni Podatki</div>
        <div class="profil-zavihek" data-target="aktualne-rezervacije" data-i18n="profile.tab_current">Aktualne Rezervacije</div>
        <div class="profil-zavihek" data-target="zgodovina" data-i18n="profile.tab_history">Zgodovina Rezervacij</div>
        <div class="profil-zavihek" data-target="tocke-kartica" data-i18n="profile.tab_points_payment">Toƒçke in Plaƒçilo</div>
        <div class="profil-zavihek" data-target="obvestila" data-i18n="profile.tab_notifications">Obvestila</div>
      </div>

      <div class="vsebina-zavihek active" id="osnovni-podatki">
        <h3 data-i18n="profile.data_subtitle">Va≈°i podatki</h3>
        <div class="kartica-podatkov">
            <p id="profil-ime"><strong data-i18n="profile.name_label">Ime in priimek:</strong> <span class="placeholder-text">Nalaganje...</span></p>
            <p id="profil-email"><strong data-i18n="profile.email_label">E-po≈°ta:</strong> <span class="placeholder-text">Nalaganje...</span></p>
            <button data-i18n="profile.edit_button">Uredi podatke</button>
            
            <button class="gumb-odjava" id="gumb-odjava" data-i18n="header.logout">
                <i class="fas fa-sign-out-alt"></i> 
                Odjava
            </button>
        </div>
      </div>

      <div class="vsebina-zavihek" id="aktualne-rezervacije">
        <h3 data-i18n="profile.current_subtitle">Aktivne rezervacije</h3>
        </div>

      <div class="vsebina-zavihek" id="zgodovina">
        <h3 data-i18n="profile.history_subtitle">Pretekle rezervacije</h3>
        </div>

      <div class="vsebina-zavihek" id="tocke-kartica">
        <h3 data-i18n="profile.points_payment_subtitle">Toƒçke in Plaƒçilna sredstva</h3>
        <div class="kartica-podatkov">
            <h4 data-i18n="profile.points_title">Va≈°e zbrane toƒçke</h4>
            <p id="tocke-status-prikaz" data-i18n="profile.points_status">Nalaganje toƒçk...</p>
        </div>

        <div class="kartica-podatkov">
            <h4 data-i18n="profile.card_title">Shranjena kreditna kartica</h4>
            <p id="kartica-info" data-i18n="profile.card_info">Visa konƒçnica: **** 1234</p>
            <button id="gumb-dodaj-kartico" data-i18n="profile.add_card_button">Dodaj/Posodobi kartico</button>
            
            <div id="kartica-formular" class="kartica-formular skrij-formular">
                <hr style="margin-top: 20px; border: 0; border-top: 1px solid #ccc;">
                <form id="formular-kartice">
                    <div>
                        <label for="stevilka-kartice">≈†tevilka kartice:</label>
                        <input type="text" id="stevilka-kartice" name="stevilka-kartice" placeholder="XXXX XXXX XXXX XXXX" required>
                    </div>

                    <div>
                        <label for="ime-na-kartici">Ime na kartici:</label>
                        <input type="text" id="ime-na-kartici" name="ime-na-kartici" placeholder="Ime in Priimek" required>
                    </div>

                    <div class="flex-vrsta">
                        <div>
                            <label for="veljavnost-kartice">Veljavnost (MM/LL):</label>
                            <input type="month" id="veljavnost-kartice" name="veljavnost-kartice" required>
                        </div>
                        <div>
                            <label for="cvv-kartice">CVV:</label>
                            <input type="text" id="cvv-kartice" name="cvv-kartice" placeholder="XXX" required pattern="\d{3,4}" title="CVV mora biti 3 ali 4 mestna ≈°tevilka">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button type="submit" data-i18n="profile.save_card_button">Shrani kartico</button>
                        <button type="button" class="gumb-odjava gumb-preklici" id="gumb-preklici-kartico" data-i18n="profile.cancel_button">Prekliƒçi</button>
                    </div>
                </form>
            </div>
            </div>
      </div>
      
      <div class="vsebina-zavihek" id="obvestila">
        <h3 data-i18n="profile.notifications_subtitle">Va≈°a obvestila</h3>
        <p>Tukaj se bodo prikazovala va≈°a sistemska obvestila (npr. potrditve in opomini rezervacij).</p>
      </div>
      
    </section>
    
    <div id="modal-ocena" class="skrij-modal">
        <div class="modal-vsebina">
            <span class="zapri-gumb">&times;</span>
            <h3 id="modal-ocena-naslov" data-i18n="profile.rate_title">Ocenite Restavracijo</h3>
            
            <form id="formular-ocena">
                <input type="hidden" id="ocena-restavracija-id" name="restavracijaId">
                <input type="hidden" id="ocena-rezervacija-id" name="rezervacijaId">

                <div class="rating-wrapper">
                    <div style="display:none;">
                   <label for="ocena-skrita" data-i18n="profile.rating_label">Ocena (1-5):</label>
<select id="ocena-skrita" name="ocena" required>
    <option value="5" data-i18n-ignore>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
    <option value="4" data-i18n-ignore>‚≠ê‚≠ê‚≠ê‚≠ê</option>
    <option value="3" data-i18n-ignore>‚≠ê‚≠ê‚≠ê</option>
    <option value="2" data-i18n-ignore>‚≠ê‚≠ê</option>
    <option value="1" data-i18n-ignore>‚≠ê</option>
</select>
                    </div>

                    <label data-i18n="profile.rating_label" style="display: block; margin-bottom: 5px;">Ocena (1-5):</label>
                    <div class="star-rating-display">
                        <div id="visual-rating" class="star-group" data-value="5">
                            <span data-value="5">‚òÖ</span>
                            <span data-value="4">‚òÖ</span>
                            <span data-value="3">‚òÖ</span>
                            <span data-value="2">‚òÖ</span>
                            <span data-value="1">‚òÖ</span>
                        </div>
                        <span id="rating-text" class="rating-text"></span>
                    </div>
                </div>
                <div>
                    <label for="komentar" data-i18n="profile.comment_label">Komentar:</label>
                    <textarea id="komentar" name="komentar" rows="4" placeholder="..."></textarea>
                </div>
                
                <button type="submit" data-i18n="profile.submit_review">Oddaj Oceno</button>
            </form>
        </div>
    </div>
    </main>

  <footer class="noga">
    <div class="noga-avtorske-pravice">
      ¬© 2025 Rentyo Gourmet. Vse pravice pridr≈æane.
    </div>
  </footer>
  <script>
        // ===========================================
        // API KONFIGURACIJA
        // ===========================================
        const BASE_URL = 'https://rentyo-gourmet-spletna-stran.onrender.com/api/';
        
        // API poti
        const PROFIL_API_URL = `${BASE_URL}auth/profil`;
        const AKTIVNE_REZERVACIJE_API_URL = `${BASE_URL}restavracije/uporabnik/aktivne`;
        const ZGODOVINA_REZERVACIJ_API_URL = `${BASE_URL}restavracije/uporabnik/zgodovina`;
        const PREKLIC_REZERVACIJE_API_URL = `${BASE_URL}restavracije/izbrisi_rezervacijo`;
        const ODDAJ_OCENO_API_URL = `${BASE_URL}restavracije/oceni`; 

        // ===========================================
        // Elementi modala in podatki
        // ===========================================
        const modalOcena = document.getElementById('modal-ocena');
        const modalZapriGumb = document.querySelector('#modal-ocena .zapri-gumb');
        const formularOcena = document.getElementById('formular-ocena');
        const ocenaRestavracijaIdInput = document.getElementById('ocena-restavracija-id'); 
        const ocenaRezervacijaIdInput = document.getElementById('ocena-rezervacija-id'); 
        const modalOcenaNaslov = document.getElementById('modal-ocena-naslov');
        const sporociloOvoj = document.getElementById('sporocilo-ovoj'); // üåü NOVO: Ovoj za sporoƒçila
        
        // üöÄ NOVO: Elementi za zvezdice
        const visualRating = document.getElementById('visual-rating');
        const hiddenSelect = document.getElementById('ocena-skrita');
        const ratingText = document.getElementById('rating-text');
        
        // Elemente za prikaz podatkov
        const podatkiImeElement = document.getElementById('profil-ime'); 
        const podatkiEmailElement = document.getElementById('profil-email'); 
        const aktivneRezervacijeKontejner = document.getElementById('aktualne-rezervacije');
        const zgodovinaRezervacijKontejner = document.getElementById('zgodovina');
        const tockeStatusElement = document.getElementById('tocke-status-prikaz');


        // ===========================================
        // 1. FUNKCIJA ZA PRIKAZ SPOROƒåIL (ZAMENJAVA ZA alert())
        // ===========================================
        
        /**
         * Prikazuje sporoƒçilo o uspehu ali napaki na vrhu strani.
         * @param {string} tip 'success' ali 'error'
         * @param {string} sporocilo Besedilo sporoƒçila
         */
        const prikaziSporocilo = (tip, sporocilo) => {
            const sporociloDiv = document.createElement('div');
            sporociloDiv.classList.add('sporocilo', tip);
            sporociloDiv.textContent = sporocilo;

            sporociloOvoj.appendChild(sporociloDiv);
            
            // Poka≈æi sporoƒçilo
            setTimeout(() => sporociloDiv.classList.add('visible'), 10);

            // Skrij in odstrani po 5 sekundah
            setTimeout(() => {
                sporociloDiv.classList.remove('visible');
                setTimeout(() => sporociloOvoj.removeChild(sporociloDiv), 300);
            }, 5000);
        };

        // ===========================================
        // 2. OSNOVNA LOGIKA ZA MENJAVO ZAVIHkov (NESPREMENJENO)
        // ===========================================
        const zavihki = document.querySelectorAll(".profil-zavihek");
        const vsebine = document.querySelectorAll(".vsebina-zavihek");

        zavihki.forEach(zavihek => {
            zavihek.addEventListener("click", () => {
                zavihki.forEach(t => t.classList.remove("active"));
                vsebine.forEach(c => c.classList.remove("active"));
                zavihek.classList.add("active");
                const targetId = zavihek.getAttribute("data-target");
                document.getElementById(targetId).classList.add("active");
            });
        });

        // ===========================================
        // 3. AVTENTIKACIJA IN NALAGANJE PODATKOV
        // ===========================================

        const zeton = localStorage.getItem('zeton');
        
        const updateHeader = () => {
            if (!zeton) {
                window.location.href = 'index.html';
            }
        };
        
        const odjava = (e) => {
            if (e) e.preventDefault();
            localStorage.removeItem('zeton'); 
            localStorage.removeItem('jeLastnik'); 
            window.location.href = 'index.html'; 
        };
        
        const posodobiPrikazPodatka = (element, labelKey, value) => {
            if (element) {
                const label = typeof i18next !== 'undefined' ? i18next.t(labelKey) : labelKey; 
                let span = element.querySelector('.placeholder-text');
                
                element.innerHTML = `<strong>${label}:</strong> `; 
                
                if(!span) {
                    span = document.createElement('span');
                    span.className = 'placeholder-text';
                }
                span.textContent = value;
                element.appendChild(span);
            }
        };

        const naloziPodatkeProfila = async () => {
            if (!zeton) return;

            const gumbOdjava = document.getElementById('gumb-odjava');
            if (gumbOdjava) {
                gumbOdjava.addEventListener('click', odjava);
            }

            try {
                const response = await fetch(PROFIL_API_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}` 
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const uporabnik = data.uporabnik || data; 

                    if (uporabnik && uporabnik.ime && uporabnik.email) {
                        posodobiPrikazPodatka(podatkiImeElement, 'profile.name_label', uporabnik.ime);
                        posodobiPrikazPodatka(podatkiEmailElement, 'profile.email_label', uporabnik.email);
                        
                        if (tockeStatusElement && uporabnik.tockeZvestobe !== undefined) {
                            const tocke = uporabnik.tockeZvestobe;
                            const tockeZaEuro = 45; 
                            const vrednostVPopustu = (tocke / tockeZaEuro).toFixed(2); 
                            
                            const statusText = i18next.t('profile.points_status_dynamic', {
                                count: tocke, 
                                popust: vrednostVPopustu 
                            });

                            tockeStatusElement.innerHTML = statusText; 

                        } else if (tockeStatusElement) {
                             // üåü POPRAVEK: Uporaba translation key
                             tockeStatusElement.textContent = i18next.t('profile.points_loading');
                        }
                        
                    } else {
                        console.error("Podatki uporabnika so nepopolni ali v napaƒçni obliki.", data);
                    }
                    
                } else if (response.status === 401 || response.status === 403) {
                    console.error("Avtorizacija neuspe≈°na:", response.status);
                    odjava();
                } else {
                    console.error("Napaka pri nalaganju profila:", response.status);
                }

            } catch (error) {
                console.error("Napaka pri komunikaciji z backendom:", error);
            }
        };

        // ===========================================
        // 4. LOGIKA ZA REZERVACIJE IN OCENJEVANJE 
        // ===========================================
        
        const prekliciRezervacijo = async (restavracijaId, mizaId, rezervacijaId) => {
            
            if (!window.confirm(i18next.t('profile.cancel_confirmation'))) return;
            
            try {
                const response = await fetch(PREKLIC_REZERVACIJE_API_URL, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}`
                    },
                    body: JSON.stringify({ 
                        restavracijaId, 
                        mizaId, 
                        rezervacijaId 
                    })
                });

                if (response.ok) {
                    prikaziSporocilo('success', i18next.t('profile.cancel_success'));
                    naloziAktivneRezervacije(); 
                    naloziZgodovinoRezervacij();
                } else {
                    const errorData = await response.json().catch(() => ({ msg: response.statusText }));
                    console.error("SERVER RESPONSE ERROR on cancellation:", response.status, errorData);
                    prikaziSporocilo('error', `${i18next.t('profile.cancel_error')}: ${errorData.msg || response.statusText}. Prosimo, preverite konzolo za podrobnosti.`);
                }
            } catch (error) {
                console.error("Napaka pri preklicu rezervacije:", error);
                prikaziSporocilo('error', i18next.t('profile.server_error'));
            }
        };

        const renderRezervacije = (rezervacije, kontejnerElement, jeAktivnaLista) => {
            const h3 = kontejnerElement.querySelector('h3');
            kontejnerElement.innerHTML = '';
            if (h3) kontejnerElement.appendChild(h3);

            if (!rezervacije || rezervacije.length === 0) {
                const sporocilo = jeAktivnaLista 
                    ? i18next.t('profile.no_current_reservations')
                    : i18next.t('profile.no_history_reservations');
                
                const p = document.createElement('p');
                p.textContent = sporocilo;
                p.style.padding = '15px 20px';
                p.style.backgroundColor = '#f8f8f8';
                p.style.borderRadius = '8px';
                kontejnerElement.appendChild(p);
                return;
            }

            rezervacije.forEach(rez => {
                const kartica = document.createElement('div');
                kartica.classList.add('kartica-rezervacije', 'kartica-podatkov'); 
                kartica.style.padding = '15px 20px';
                kartica.style.marginBottom = '10px';
                kartica.style.border = '1px solid #ccc';
                kartica.style.borderRadius = '8px';
                kartica.style.display = 'flex';
                kartica.style.flexDirection = 'row'; 
                kartica.style.justifyContent = 'space-between'; 
                kartica.style.alignItems = 'center';
                kartica.style.gap = '15px';
                kartica.style.backgroundColor = '#fff';
                
                if (!jeAktivnaLista) {
                    const currentStatus = rez.status?.toUpperCase() || 'POTRJENO'; 
                    const isCancelled = currentStatus === 'PREKLICANO'; 
                    // üîë KLJUƒåNA SPREMEMBA: Uporaba predpostavljene lastnosti `ocenjeno`
                    const jeZeOcenjeno = rez.ocenjeno || false; 
                    
                    // üö® VEDNO DODAJ RAZRED .pretekla, ƒåE NI AKTIVNA LISTA
                    kartica.classList.add('pretekla'); 
                    
                    // üåü NOVO: Dodajanje razredov za loƒçitev
                    if (isCancelled) {
                        kartica.classList.add('preklicano'); 
                    } else if (jeZeOcenjeno) {
                        // üîë KLJUƒåNA SPREMEMBA: Doda se razred, ki CSS-u naroƒçi loƒçitev
                        kartica.classList.add('ocenjeno'); 
                    } 
                    
                    // üåü KLJUƒåNA LOGIKA: Event listener za odpiranje modala
                    if (!jeZeOcenjeno && !isCancelled) {
                        kartica.style.cursor = 'pointer';
                        kartica.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'BUTTON') { 
                                odpriModalOcena(rez.restavracijaId, rez._id, rez.ime_restavracije);
                            }
                        });
                    } else {
                        kartica.style.cursor = 'default';
                    }
                    
                    kartica.dataset.restavracijaId = rez.restavracijaId;
                    kartica.dataset.rezervacijaId = rez._id; 
                    kartica.dataset.imeRestavracije = rez.ime_restavracije;
                    
                }
                
                // --- 1. Podatki o rezervaciji ---
                const cas = rez.cas_rezervacije;
                const ura = Math.floor(cas); 
                const minute = Math.round((cas - ura) * 60); 
                const casIzpis = `${ura.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

                const podatkiDiv = document.createElement('div');
                podatkiDiv.classList.add('rezervacija-podatki');
                
let htmlContent = `
    <p style="font-weight: bold; margin: 0;">${rez.ime_restavracije}</p>
    
    <p style="margin: 5px 0 0 0; display: flex; align-items: center;">
        
        <span class="flex items-center mr-10"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle text-gray-500 mr-2"> 
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg> 
            <span>${rez.datum_rezervacije}</span>
        </span>
        
        <span class="flex items-center mr-10"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle text-gray-500 mr-2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg> 
            <span>${casIzpis}</span>
        </span>
        
        <span class="flex items-center"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle text-gray-500 mr-2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <span>${rez.stevilo_oseb}</span>
        </span>
    </p>
`;

                // Logika za status v zgodovini
                if (!jeAktivnaLista) {
                    const currentStatus = rez.status?.toUpperCase() || 'POTRJENO'; 
                    const isCancelled = currentStatus === 'PREKLICANO'; 
                    // Preveri, ali je bil razred dodan (kar pomeni, da je rez.ocenjeno TRUE iz API-ja)
                    const jeZeOcenjeno = kartica.classList.contains('ocenjeno'); 
                    
                    let statusTextHtml = '';

                    if (isCancelled) {
                        statusTextHtml = `<p style="margin: 5px 0 0 0; font-weight: bold; color: orange;">${i18next.t('profile.status_cancelled')}</p>`;
                    } else if (jeZeOcenjeno) {
                        // üåü IZPIS "OCENJENO"
                        statusTextHtml = `<p style="margin: 5px 0 0 0; font-weight: bold; color: #575757;">
                                            <i class="fas fa-check-circle" style="color: #20c0bd;"></i> 
                                            ${i18next.t('profile.status_rated')}
                                        </p>`;
                    } else {
                        // üåü IZPIS "KLIKNITE ZA OCENO"
                         statusTextHtml = `<p style="margin: 5px 0 0 0; font-weight: bold; color:#20c0bd;">
                                            ${i18next.t('profile.status_rate_now')}
                                        </p>`;
                    }

                    htmlContent += statusTextHtml;
                }
                
                podatkiDiv.innerHTML = htmlContent;
                kartica.appendChild(podatkiDiv);
                
                // --- 2. Gumb za preklic (Samo za aktivne) ---
                if (jeAktivnaLista) {
                    const preklicGumb = document.createElement('button');
                    preklicGumb.classList.add('gumb-preklici');
                    preklicGumb.textContent = i18next.t('profile.cancel_button');
                    preklicGumb.style.flexShrink = '0'; 

                    const mizaId = rez.mizaId; 
                    
                    preklicGumb.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        prekliciRezervacijo(rez.restavracijaId, mizaId, rez._id);
                    });
                    
                    kartica.appendChild(preklicGumb);
                }

                kontejnerElement.appendChild(kartica);
            });
        };

        const naloziAktivneRezervacije = async () => {
            try {
                const response = await fetch(AKTIVNE_REZERVACIJE_API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${zeton}` }
                });

                if (response.ok) {
                    const rezervacije = await response.json();
                    renderRezervacije(rezervacije, aktivneRezervacijeKontejner, true);
                } else if (response.status === 401 || response.status === 403) {
                    renderRezervacije([], aktivneRezervacijeKontejner, true);
                } else {
                    console.error("Napaka pri nalaganju aktivnih rezervacij:", response.status);
                    aktivneRezervacijeKontejner.innerHTML += `<p style="color: red;">${i18next.t('profile.loading_error')}</p>`;
                }
            } catch (error) {
                console.error("Kritiƒçna napaka pri nalaganju aktivnih rezervacij:", error);
            }
        };

        const naloziZgodovinoRezervacij = async () => {
            try {
                const response = await fetch(ZGODOVINA_REZERVACIJ_API_URL, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${zeton}` }
                });

                if (response.ok) {
                    const rezervacije = await response.json();
                    renderRezervacije(rezervacije, zgodovinaRezervacijKontejner, false);
                } else if (response.status === 401 || response.status === 403) {
                    renderRezervacije([], zgodovinaRezervacijKontejner, false);
                } else {
                    console.error("Napaka pri nalaganju zgodovine rezervacij:", response.status);
                    zgodovinaRezervacijKontejner.innerHTML += `<p style="color: red;">${i18next.t('profile.loading_error')}</p>`;
                }
            } catch (error) {
                console.error("Kritiƒçna napaka pri nalaganju zgodovine rezervacij:", error);
            }
        };


        // ===========================================
        // 5. LOGIKA ZA OCENJEVANJE IN ZVEZDICE 
        // ===========================================
        
        /**
         * Odpre modal za ocenjevanje in napolni polja
         */
        const odpriModalOcena = (restavracijaId, rezervacijaId, imeRestavracije) => {
            modalOcenaNaslov.textContent = `${i18next.t('profile.rate_title')} ${imeRestavracije}`;
            ocenaRestavracijaIdInput.value = restavracijaId; 
            ocenaRezervacijaIdInput.value = rezervacijaId; 
            
            // Poƒçisti vnosna polja in inicializiraj zvezdice
            hiddenSelect.value = '5'; // Nastavi privzeto na 5
            document.getElementById('komentar').value = '';
            
            // üöÄ KLJUƒåNO: Inicializacija prikaza zvezdic
            updateStarRating(5); 

            modalOcena.classList.remove('skrij-modal');
        };

        /**
         * Zapre modal za ocenjevanje
         */
        const zapriModalOcena = () => {
            modalOcena.classList.add('skrij-modal');
            // Ponovno nalo≈æi zgodovino, da se posodobi status ocenjene rezervacije
            naloziZgodovinoRezervacij();
        };

        /**
         * Po≈°lje oceno in komentar na API
         */
        const oddajOcenoInKomentar = async (e) => {
            e.preventDefault();

            const restavracijaId = ocenaRestavracijaIdInput.value;
            const rezervacijaId = ocenaRezervacijaIdInput.value;
            const ocena = hiddenSelect.value;
            const komentar = document.getElementById('komentar').value;
            
            if (!restavracijaId || !rezervacijaId || !ocena) {
                prikaziSporocilo('error', i18next.t('profile.review_missing_data'));
                return;
            }

            const urlZKlicem = `${ODDAJ_OCENO_API_URL}/${restavracijaId}`;

            try {
                const response = await fetch(urlZKlicem, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${zeton}`
                    },
                    body: JSON.stringify({ 
                        restavracijaId, 
                        rezervacijaId, 
                        ocena: parseInt(ocena, 10), 
                        komentar 
                    })
                });

                if (response.ok) {
                    prikaziSporocilo('success', i18next.t('profile.review_success'));
                    zapriModalOcena();
                } else {
                    const errorData = await response.json().catch(() => ({ msg: response.statusText }));
                    console.error("SERVER RESPONSE ERROR on review submission (Preverite ID-je!):", response.status, errorData);
                    prikaziSporocilo('error', `${i18next.t('profile.review_error')}: ${errorData.msg || response.statusText}. Prosimo, preverite konzolo za podrobnosti.`);
                }

            } catch (error) {
                console.error("Napaka pri oddaji ocene (Network Error):", error);
                prikaziSporocilo('error', i18next.t('profile.server_error'));
            }
        };

        
        // ===========================================
        // üöÄ LOGIKA ZA INTERAKTIVNE ZVEZDICE üöÄ
        // ===========================================

        const ratingDescriptions = {
            '5': '',
            '4': '',
            '3': '',
            '2': '',
            '1': ''
        };

        /**
         * Posodobi vizualni prikaz zvezdic in skrito polje.
         * @param {number|string} value Izbrana ocena (1-5).
         * @param {boolean} isHover Ali je funkcija klicana ob premiku mi≈°ke.
         */
        const updateStarRating = (value, isHover = false) => {
            const stars = visualRating.querySelectorAll('span');
            const numericValue = parseInt(value);

            if (!isHover) {
                hiddenSelect.value = value;
                visualRating.setAttribute('data-value', value);
                ratingText.textContent = ratingDescriptions[value] || '';
            }

            stars.forEach(star => {
                const starValue = parseInt(star.getAttribute('data-value'));
                
                if (starValue <= numericValue) {
                    // Uporabi barvo izbranih (ali lebdeƒçih)
                    star.style.color = '#20c0bd'; 
                } else {
                    // Neaktivna barva
                    star.style.color = '#ccc'; 
                }
            });
        };

        const starRatingLogic = () => {
            if (!visualRating) return;

            // Poslu≈°alec za klik (Trajna izbira)
            visualRating.addEventListener('click', (event) => {
                if (event.target.tagName === 'SPAN') {
                    const value = event.target.getAttribute('data-value');
                    if (value) {
                        updateStarRating(value); // Uveljavi trajno izbiro
                    }
                }
            });

            // Poslu≈°alec za premik mi≈°ke (Vizualni povratni odziv - Hover)
            visualRating.addEventListener('mouseover', (event) => {
                if (event.target.tagName === 'SPAN') {
                    const hoverValue = event.target.getAttribute('data-value');
                    if (hoverValue) {
                        updateStarRating(hoverValue, true); // Prikaz samo pri lebdenju
                    }
                }
            });

            // Poslu≈°alec za zapustitev obmoƒçja zvezdic (Vrne na izbrano vrednost)
            visualRating.addEventListener('mouseleave', () => {
                const currentValue = visualRating.getAttribute('data-value') || '5';
                updateStarRating(currentValue);
            });
            
        };

        // Event listenerji za modal (Zapiranje)
        if(modalZapriGumb) {
            modalZapriGumb.addEventListener('click', zapriModalOcena);
        }
        window.addEventListener('click', (event) => {
            if (event.target === modalOcena) {
                zapriModalOcena();
            }
        });
        if(formularOcena) {
             formularOcena.addEventListener('submit', oddajOcenoInKomentar);
        }

        // ===========================================
        // 6. i18next IN ZAGON
        // ===========================================

        const updateContent = () => {
          document.querySelectorAll("[data-i18n]").forEach((el) => {
            const key = el.getAttribute("data-i18n");
            if (el.tagName === 'BUTTON' || el.classList.contains('profil-zavihek')) {
                const ikona = el.querySelector('.fas');
                el.textContent = i18next.t(key);
                if (ikona) el.prepend(ikona);
            } else {
                el.textContent = i18next.t(key);
            }
          });
          
          document.title = i18next.t("app.profile_title");

          const imeLabel = i18next.t('profile.name_label');
          const emailLabel = i18next.t('profile.email_label');

          if (podatkiImeElement) {
              const content = podatkiImeElement.querySelector('span')?.textContent || '';
              podatkiImeElement.innerHTML = `<strong>${imeLabel}:</strong> <span class="placeholder-text">${content}</span>`;
          }
          if (podatkiEmailElement) {
              const content = podatkiEmailElement.querySelector('span')?.textContent || '';
              podatkiEmailElement.innerHTML = `<strong>${emailLabel}:</strong> <span class="placeholder-text">${content}</span>`;
          }
          
          if (modalOcenaNaslov) {
             modalOcenaNaslov.textContent = i18next.t('profile.rate_title');
          }
        };

        const loadLanguage = () => {
            return localStorage.getItem('i18nextLng') || 'sl'; 
        };
        
        i18next.use(i18nextHttpBackend).init(
            {
                lng: loadLanguage(), 
                fallbackLng: "sl",
                backend: { loadPath: "./i18n/{{lng}}.json" }, 
                interpolation: {
                    escapeValue: false, 
                }
            },
            (err) => {
                if (err) console.error("i18next napaka pri nalaganju: ", err);
                
                updateContent();
                updateHeader();
                
                // ZAGON NALAGANJA PODATKOV IN REZERVACIJ
                naloziPodatkeProfila(); 
                naloziAktivneRezervacije(); 
                naloziZgodovinoRezervacij(); 
                
                // üöÄ ZAGON LOGIKE ZA ZVEZDICE
                starRatingLogic(); 
                
                // Logika: Prikaz/skrivanje formularja za kartico
                const gumbDodajKartico = document.getElementById('gumb-dodaj-kartico');
                const formularKartice = document.getElementById('kartica-formular');
                const gumbPrekliciKartico = document.getElementById('gumb-preklici-kartico');
                
                // POƒåISTIMO STATIƒåNO VSEBINO v "Aktualne rezervacije" in "Zgodovina rezervacij"
                aktivneRezervacijeKontejner.innerHTML = `<h3 data-i18n="profile.current_subtitle">Aktivne rezervacije</h3>`;
                zgodovinaRezervacijKontejner.innerHTML = `<h3 data-i18n="profile.history_subtitle">Pretekle rezervacije</h3>`;


                if (gumbDodajKartico && formularKartice && gumbPrekliciKartico) {
                    
                    const preklopiPrikazFormularja = () => {
                        formularKartice.classList.toggle('skrij-formular');
                        const jePrikazan = !formularKartice.classList.contains('skrij-formular');
                        gumbDodajKartico.textContent = i18next.t(jePrikazan ? 'profile.hide_card_button' : 'profile.add_card_button');
                    };

                    gumbDodajKartico.addEventListener('click', preklopiPrikazFormularja);
                    gumbPrekliciKartico.addEventListener('click', preklopiPrikazFormularja);

                    const form = document.getElementById('formular-kartice');
                    if (form) {
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            prikaziSporocilo('success', i18next.t('profile.card_saved'));
                            preklopiPrikazFormularja();
                        });
                    }
                }
            }
        );
    </script>
</body>
</html>